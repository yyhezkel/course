<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>×”×’×“×¨×ª ×¤×¨×˜×™ ×”×ª×—×‘×¨×•×ª</title>
    <link rel="stylesheet" href="style.css?v=2.0">
</head>
<body>
    <!-- Background Decoration -->
    <div class="background-decoration"></div>

    <!-- Setup Screen -->
    <div id="setup-screen" class="screen active">
        <div class="container">
            <div class="logo-container">
                <div class="logo-icon">ğŸ”‘</div>
                <h1 class="app-title">×”×’×“×¨×ª ×¤×¨×˜×™ ×”×ª×—×‘×¨×•×ª</h1>
                <p class="app-subtitle">×¦×•×¨ ××™××™×™×œ ×•×¡×™×¡××” ×—×–×§×” ×œ×—×©×‘×•×Ÿ ×©×œ×š</p>
            </div>

            <div class="card">
                <div class="card-header">
                    <h2>×™×¦×™×¨×ª ×¤×¨×˜×™ ×’×™×©×”</h2>
                    <p>××¢×ª×” ×ª×•×›×œ ×œ×”×ª×—×‘×¨ ×¨×§ ×‘×××¦×¢×•×ª ×”××™××™×™×œ ×•×”×¡×™×¡××”</p>
                </div>

                <div class="card-body">
                    <div class="input-group">
                        <label for="username-input" class="input-label">×›×ª×•×‘×ª ××™××™×™×œ</label>
                        <input
                            type="email"
                            id="username-input"
                            placeholder="your.email@example.com"
                            class="input-field"
                            autocomplete="email"
                        >
                        <div class="input-icon">ğŸ“§</div>
                        <small style="display: block; margin-top: 5px; color: #6b7280; font-size: 0.875rem;">
                            ×”×–×Ÿ ×›×ª×•×‘×ª ××™××™×™×œ ×ª×§×™× ×”
                        </small>
                    </div>

                    <div class="input-group" style="margin-top: 15px;">
                        <label for="password-input" class="input-label">×¡×™×¡××”</label>
                        <input
                            type="password"
                            id="password-input"
                            placeholder="×œ×¤×—×•×ª 8 ×ª×•×•×™×"
                            class="input-field"
                            autocomplete="new-password"
                            minlength="8"
                        >
                        <div class="input-icon">ğŸ”’</div>
                        <small style="display: block; margin-top: 5px; color: #6b7280; font-size: 0.875rem;">
                            ×”×¡×™×¡××” ×—×™×™×‘×ª ×œ×”×›×™×œ ×œ×¤×—×•×ª 8 ×ª×•×•×™×, ××•×ª ×’×“×•×œ×”, ××¡×¤×¨ ×•×ª×• ××™×•×—×“
                        </small>
                    </div>

                    <div class="input-group" style="margin-top: 15px;">
                        <label for="confirm-password-input" class="input-label">××™××•×ª ×¡×™×¡××”</label>
                        <input
                            type="password"
                            id="confirm-password-input"
                            placeholder="×”×–×Ÿ ××ª ×”×¡×™×¡××” ×©×•×‘"
                            class="input-field"
                            autocomplete="new-password"
                            minlength="6"
                        >
                        <div class="input-icon">ğŸ”’</div>
                    </div>

                    <div id="error-message" class="alert alert-error" style="display:none;"></div>
                    <div id="success-message" class="alert alert-success" style="display:none;"></div>

                    <button id="setup-button" class="btn btn-primary btn-large">
                        <span>×©××•×¨ ×•×”××©×š</span>
                        <span class="btn-arrow">â†</span>
                    </button>
                </div>
            </div>

            <div class="security-badge">
                <span class="badge-icon">ğŸ”’</span>
                <span>×—×™×‘×•×¨ ×××•×‘×˜×—</span>
            </div>
        </div>
    </div>

    <script>
        // Check if user is authenticated and needs to setup credentials
        window.addEventListener('DOMContentLoaded', async () => {
            const authenticated = await checkSession();
            if (!authenticated) {
                window.location.href = 'index.html';
                return;
            }

            // Check if user already has credentials set
            const needsSetup = await checkNeedsSetup();
            if (!needsSetup) {
                // User already has credentials, redirect to dashboard
                window.location.href = 'dashboard.html';
                return;
            }
        });

        async function checkSession() {
            try {
                const response = await fetch('api.php', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    credentials: 'include',
                    body: JSON.stringify({ action: 'check_session' })
                });
                const data = await response.json();
                return data.authenticated;
            } catch (error) {
                console.error('Session check error:', error);
                return false;
            }
        }

        async function checkNeedsSetup() {
            try {
                const response = await fetch('api.php', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    credentials: 'include',
                    body: JSON.stringify({ action: 'check_needs_credential_setup' })
                });
                const data = await response.json();
                return data.needs_setup === true;
            } catch (error) {
                console.error('Check needs setup error:', error);
                return false;
            }
        }

        function displayError(message) {
            const errorDiv = document.getElementById('error-message');
            const successDiv = document.getElementById('success-message');
            successDiv.style.display = 'none';
            errorDiv.textContent = message;
            errorDiv.style.display = 'block';

            // Scroll to error
            errorDiv.scrollIntoView({ behavior: 'smooth', block: 'center' });
        }

        function displaySuccess(message) {
            const errorDiv = document.getElementById('error-message');
            const successDiv = document.getElementById('success-message');
            errorDiv.style.display = 'none';
            successDiv.textContent = message;
            successDiv.style.display = 'block';
        }

        function hideMessages() {
            document.getElementById('error-message').style.display = 'none';
            document.getElementById('success-message').style.display = 'none';
        }

        // Setup button click handler
        document.getElementById('setup-button').addEventListener('click', async () => {
            hideMessages();

            const email = document.getElementById('username-input').value.trim();
            const password = document.getElementById('password-input').value;
            const confirmPassword = document.getElementById('confirm-password-input').value;

            // Email validation
            const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
            if (!email || !emailRegex.test(email)) {
                displayError('× × ×œ×”×–×™×Ÿ ×›×ª×•×‘×ª ××™××™×™×œ ×ª×§×™× ×”');
                return;
            }

            // Password strength validation
            if (!password || password.length < 8) {
                displayError('×”×¡×™×¡××” ×—×™×™×‘×ª ×œ×”×›×™×œ ×œ×¤×—×•×ª 8 ×ª×•×•×™×');
                return;
            }

            if (!/[A-Z]/.test(password)) {
                displayError('×”×¡×™×¡××” ×—×™×™×‘×ª ×œ×”×›×™×œ ×œ×¤×—×•×ª ××•×ª ××—×ª ×’×“×•×œ×” (A-Z)');
                return;
            }

            if (!/[0-9]/.test(password)) {
                displayError('×”×¡×™×¡××” ×—×™×™×‘×ª ×œ×”×›×™×œ ×œ×¤×—×•×ª ×¡×¤×¨×” ××—×ª (0-9)');
                return;
            }

            if (!/[!@#$%^&*()_+\-=\[\]{};':"\\|,.<>\/?]/.test(password)) {
                displayError('×”×¡×™×¡××” ×—×™×™×‘×ª ×œ×”×›×™×œ ×œ×¤×—×•×ª ×ª×• ××™×•×—×“ ××—×“ (!@#$%^&* ×•×›×•\')');
                return;
            }

            if (password !== confirmPassword) {
                displayError('×”×¡×™×¡×××•×ª ××™× ×Ÿ ×ª×•×××•×ª');
                return;
            }

            // Disable button
            const button = document.getElementById('setup-button');
            button.disabled = true;
            button.innerHTML = '<span>×©×•××¨...</span>';

            try {
                const response = await fetch('api.php', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    credentials: 'include',
                    body: JSON.stringify({
                        action: 'setup_credentials',
                        username: email,
                        password: password
                    })
                });

                const data = await response.json();

                if (data.success) {
                    displaySuccess('×¤×¨×˜×™ ×”×”×ª×—×‘×¨×•×ª × ×©××¨×• ×‘×”×¦×œ×—×”! ××¢×‘×™×¨ ×œ×œ×•×— ×”×‘×§×¨×”...');

                    // Redirect to dashboard after 2 seconds
                    setTimeout(() => {
                        window.location.href = 'dashboard.html';
                    }, 2000);
                } else {
                    displayError(data.message || '×©×’×™××” ×‘×©××™×¨×ª ×¤×¨×˜×™ ×”×”×ª×—×‘×¨×•×ª');
                    button.disabled = false;
                    button.innerHTML = '<span>×©××•×¨ ×•×”××©×š</span><span class="btn-arrow">â†</span>';
                }
            } catch (error) {
                console.error('Setup error:', error);
                displayError('×©×’×™××ª ×ª×§×©×•×¨×ª. ×× × × ×¡×” ×©×•×‘.');
                button.disabled = false;
                button.innerHTML = '<span>×©××•×¨ ×•×”××©×š</span><span class="btn-arrow">â†</span>';
            }
        });

        // Enter key support
        document.getElementById('confirm-password-input').addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                document.getElementById('setup-button').click();
            }
        });
    </script>
</body>
</html>
