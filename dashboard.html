<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>×œ×•×— ×”××©×™××•×ª ×©×œ×™</title>
    <link rel="stylesheet" href="style.css">
    <style>
        .dashboard-container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        .welcome-section {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 30px;
            border-radius: 15px;
            margin-bottom: 30px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }

        .welcome-section h1 {
            margin: 0 0 10px 0;
            font-size: 28px;
        }

        .welcome-section p {
            margin: 0;
            opacity: 0.9;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            text-align: center;
        }

        .stat-card .stat-number {
            font-size: 36px;
            font-weight: bold;
            color: #667eea;
            margin-bottom: 5px;
        }

        .stat-card .stat-label {
            color: #666;
            font-size: 14px;
        }

        .progress-section {
            background: white;
            padding: 25px;
            border-radius: 10px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            margin-bottom: 30px;
        }

        .progress-section h2 {
            margin-top: 0;
            color: #333;
            font-size: 20px;
        }

        .progress-bar-container {
            width: 100%;
            height: 30px;
            background: #f0f0f0;
            border-radius: 15px;
            overflow: hidden;
            position: relative;
        }

        .progress-bar-fill {
            height: 100%;
            background: linear-gradient(90deg, #667eea 0%, #764ba2 100%);
            transition: width 0.5s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
            font-size: 14px;
        }

        .tasks-section {
            margin-bottom: 30px;
        }

        .tasks-section h2 {
            color: #333;
            margin-bottom: 20px;
            font-size: 24px;
        }

        .task-card {
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            margin-bottom: 15px;
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s;
            border-right: 4px solid #667eea;
        }

        .task-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.15);
        }

        .task-card.completed {
            border-right-color: #4caf50;
            opacity: 0.8;
        }

        .task-card.in-progress {
            border-right-color: #ff9800;
        }

        .task-card.needs-review {
            border-right-color: #2196f3;
        }

        .task-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 10px;
        }

        .task-title {
            font-size: 18px;
            font-weight: bold;
            color: #333;
            margin: 0;
        }

        .task-status {
            padding: 5px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: bold;
        }

        .task-status.pending {
            background: #fff3cd;
            color: #856404;
        }

        .task-status.in-progress {
            background: #fff3e0;
            color: #e65100;
        }

        .task-status.completed {
            background: #d4edda;
            color: #155724;
        }

        .task-status.needs-review {
            background: #d1ecf1;
            color: #0c5460;
        }

        .task-description {
            color: #666;
            margin: 10px 0;
            font-size: 14px;
        }

        .task-meta {
            display: flex;
            gap: 15px;
            font-size: 13px;
            color: #999;
            margin-top: 10px;
        }

        .task-meta-item {
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .no-tasks {
            text-align: center;
            padding: 40px;
            color: #999;
        }

        .no-tasks-icon {
            font-size: 48px;
            margin-bottom: 10px;
        }

        .notifications-badge {
            background: #f44336;
            color: white;
            border-radius: 50%;
            padding: 2px 6px;
            font-size: 11px;
            margin-right: 5px;
        }

        .logout-btn {
            background: rgba(255,255,255,0.2);
            color: white;
            border: 2px solid white;
            padding: 8px 20px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 14px;
            transition: background 0.3s;
        }

        .logout-btn:hover {
            background: rgba(255,255,255,0.3);
        }

        .loading {
            text-align: center;
            padding: 40px;
            color: #666;
        }

        .spinner {
            border: 3px solid #f3f3f3;
            border-top: 3px solid #667eea;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        @media (max-width: 768px) {
            .stats-grid {
                grid-template-columns: repeat(2, 1fr);
            }

            .task-header {
                flex-direction: column;
                gap: 10px;
            }

            .task-meta {
                flex-direction: column;
                gap: 5px;
            }
        }
    </style>
</head>
<body>
    <div class="dashboard-container">
        <!-- Loading State -->
        <div id="loading" class="loading">
            <div class="spinner"></div>
            <p>×˜×•×¢×Ÿ × ×ª×•× ×™×...</p>
        </div>

        <!-- Dashboard Content (hidden initially) -->
        <div id="dashboardContent" style="display: none;">
            <!-- Welcome Section -->
            <div class="welcome-section">
                <div style="display: flex; justify-content: space-between; align-items: center;">
                    <div>
                        <h1>×©×œ×•×, <span id="userName">××©×ª××©</span>!</h1>
                        <p>×‘×¨×•×š ×”×‘× ×œ×œ×•×— ×”××©×™××•×ª ×©×œ×š</p>
                    </div>
                    <div style="display: flex; gap: 10px;">
                        <a href="profile.html" class="logout-btn" style="text-decoration: none;">ğŸ‘¤ ×”×¤×¨×•×¤×™×œ ×©×œ×™</a>
                        <button class="logout-btn" onclick="logout()">×™×¦×™××”</button>
                    </div>
                </div>
            </div>

            <!-- Stats Grid -->
            <div class="stats-grid">
                <div class="stat-card">
                    <div class="stat-number" id="totalTasks">0</div>
                    <div class="stat-label">×¡×š ×”××©×™××•×ª</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="completedTasks">0</div>
                    <div class="stat-label">××©×™××•×ª ×©×”×•×©×œ××•</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="pendingTasks">0</div>
                    <div class="stat-label">××©×™××•×ª ×××ª×™× ×•×ª</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="progressPercentage">0%</div>
                    <div class="stat-label">××—×•×– ×”×©×œ××”</div>
                </div>
            </div>

            <!-- Progress Section -->
            <div class="progress-section">
                <h2>×”×ª×§×“××•×ª ×›×œ×œ×™×ª</h2>
                <div class="progress-bar-container">
                    <div class="progress-bar-fill" id="progressBar" style="width: 0%;">0%</div>
                </div>
            </div>

            <!-- Tasks Section -->
            <div class="tasks-section">
                <h2>×”××©×™××•×ª ×©×œ×™</h2>
                <div id="tasksList"></div>
            </div>
        </div>
    </div>

    <script>
        let userData = null;
        let userTasks = [];

        // Check authentication on load
        window.addEventListener('DOMContentLoaded', async () => {
            const authenticated = await checkSession();
            if (!authenticated) {
                window.location.href = 'index.html';
                return;
            }
            await loadDashboard();
        });

        async function checkSession() {
            try {
                const response = await fetch('api.php', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    credentials: 'include',
                    body: JSON.stringify({ action: 'check_session' })
                });
                const data = await response.json();
                return data.authenticated;
            } catch (error) {
                console.error('Session check error:', error);
                return false;
            }
        }

        async function loadDashboard() {
            try {
                // Fetch dashboard data
                const response = await fetch('api.php', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    credentials: 'include',
                    body: JSON.stringify({ action: 'get_dashboard' })
                });

                if (!response.ok) {
                    throw new Error('Failed to load dashboard');
                }

                const data = await response.json();

                if (data.success) {
                    userData = data.user;
                    userTasks = data.tasks || [];

                    renderDashboard();
                } else {
                    throw new Error(data.message || 'Failed to load dashboard');
                }
            } catch (error) {
                console.error('Error loading dashboard:', error);
                document.getElementById('loading').innerHTML = `
                    <p style="color: red;">×©×’×™××” ×‘×˜×¢×™× ×ª ×”× ×ª×•× ×™×</p>
                    <p>${error.message}</p>
                    <button onclick="window.location.href='index.html'" style="padding: 10px 20px; margin-top: 10px;">×—×–×¨×” ×œ×”×ª×—×‘×¨×•×ª</button>
                `;
            }
        }

        function renderDashboard() {
            // Hide loading, show content
            document.getElementById('loading').style.display = 'none';
            document.getElementById('dashboardContent').style.display = 'block';

            // Set user name
            document.getElementById('userName').textContent = userData.tz || '××©×ª××©';

            // Calculate stats
            const total = userTasks.length;
            const completed = userTasks.filter(t => t.status === 'completed' || t.status === 'approved').length;
            const pending = userTasks.filter(t => t.status === 'pending').length;
            const percentage = total > 0 ? Math.round((completed / total) * 100) : 0;

            // Update stats
            document.getElementById('totalTasks').textContent = total;
            document.getElementById('completedTasks').textContent = completed;
            document.getElementById('pendingTasks').textContent = pending;
            document.getElementById('progressPercentage').textContent = percentage + '%';

            // Update progress bar
            const progressBar = document.getElementById('progressBar');
            progressBar.style.width = percentage + '%';
            progressBar.textContent = percentage + '%';

            // Render tasks
            renderTasks();
        }

        function renderTasks() {
            const tasksList = document.getElementById('tasksList');

            if (userTasks.length === 0) {
                tasksList.innerHTML = `
                    <div class="no-tasks">
                        <div class="no-tasks-icon">ğŸ“‹</div>
                        <p>××™×Ÿ ×œ×š ××©×™××•×ª ×›×¨×’×¢</p>
                    </div>
                `;
                return;
            }

            // Sort tasks: pending/in-progress first, then by sequence order
            const sortedTasks = [...userTasks].sort((a, b) => {
                if (a.status === 'completed' && b.status !== 'completed') return 1;
                if (a.status !== 'completed' && b.status === 'completed') return -1;
                return (a.sequence_order || 0) - (b.sequence_order || 0);
            });

            tasksList.innerHTML = sortedTasks.map(task => {
                const statusText = getStatusText(task.status);
                const statusClass = task.status.replace('_', '-');
                const dueDate = task.due_date ? new Date(task.due_date).toLocaleDateString('he-IL') : null;

                return `
                    <div class="task-card ${statusClass}" onclick="openTask(${task.id}, ${task.task_id})">
                        <div class="task-header">
                            <h3 class="task-title">${task.title}</h3>
                            <span class="task-status ${statusClass}">${statusText}</span>
                        </div>
                        ${task.description ? `<p class="task-description">${task.description}</p>` : ''}
                        <div class="task-meta">
                            ${task.estimated_duration ? `
                                <div class="task-meta-item">
                                    <span>â±ï¸</span>
                                    <span>${task.estimated_duration} ×“×§×•×ª</span>
                                </div>
                            ` : ''}
                            ${task.points ? `
                                <div class="task-meta-item">
                                    <span>â­</span>
                                    <span>${task.points} × ×§×•×“×•×ª</span>
                                </div>
                            ` : ''}
                            ${dueDate ? `
                                <div class="task-meta-item">
                                    <span>ğŸ“…</span>
                                    <span>×ª××¨×™×š ×™×¢×“: ${dueDate}</span>
                                </div>
                            ` : ''}
                        </div>
                    </div>
                `;
            }).join('');
        }

        function getStatusText(status) {
            const statusMap = {
                'pending': '×××ª×™× ×”',
                'in_progress': '×‘×ª×”×œ×™×š',
                'completed': '×”×•×©×œ××”',
                'needs_review': '×××ª×™× ×” ×œ×‘×“×™×§×”',
                'approved': '××•×©×¨×”',
                'rejected': '× ×“×—×ª×”'
            };
            return statusMap[status] || status;
        }

        function openTask(userTaskId, taskId) {
            window.location.href = `task.html?id=${userTaskId}`;
        }

        async function logout() {
            try {
                await fetch('api.php', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    credentials: 'include',
                    body: JSON.stringify({ action: 'logout' })
                });
            } catch (error) {
                console.error('Logout error:', error);
            }
            window.location.href = 'index.html';
        }
    </script>
</body>
</html>
