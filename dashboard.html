<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>×œ×•×— ×”××©×™××•×ª ×©×œ×™</title>
    <link rel="stylesheet" href="user.css">
</head>
<body>
    <div class="dashboard-container">
        <!-- Loading State -->
        <div id="loading" class="loading">
            <div class="spinner"></div>
            <p>×˜×•×¢×Ÿ × ×ª×•× ×™×...</p>
        </div>

        <!-- Dashboard Content (hidden initially) -->
        <div id="dashboardContent" style="display: none;">
            <!-- Welcome Section -->
            <div class="welcome-section">
                <div style="display: flex; justify-content: space-between; align-items: center;">
                    <div>
                        <h1>×©×œ×•×, <span id="userName">××©×ª××©</span>!</h1>
                        <p>×‘×¨×•×š ×”×‘× ×œ×œ×•×— ×”××©×™××•×ª ×©×œ×š</p>
                    </div>
                    <div style="display: flex; gap: 10px;">
                        <a href="profile.html" class="logout-btn" style="text-decoration: none;">ğŸ‘¤ ×”×¤×¨×•×¤×™×œ ×©×œ×™</a>
                        <button class="logout-btn" onclick="logout()">×™×¦×™××”</button>
                    </div>
                </div>
            </div>

            <!-- Stats Grid -->
            <div class="stats-grid">
                <div class="stat-card">
                    <div class="stat-number" id="totalTasks">0</div>
                    <div class="stat-label">×¡×š ×”××©×™××•×ª</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="completedTasks">0</div>
                    <div class="stat-label">××©×™××•×ª ×©×”×•×©×œ××•</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="pendingTasks">0</div>
                    <div class="stat-label">××©×™××•×ª ×××ª×™× ×•×ª</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="progressPercentage">0%</div>
                    <div class="stat-label">××—×•×– ×”×©×œ××”</div>
                </div>
            </div>

            <!-- Progress Section -->
            <div class="progress-section">
                <h2>×”×ª×§×“××•×ª ×›×œ×œ×™×ª</h2>
                <div class="progress-bar-container">
                    <div class="progress-bar-fill" id="progressBar" style="width: 0%;">0%</div>
                </div>
            </div>

            <!-- Tasks Section -->
            <div class="tasks-section">
                <h2>×”××©×™××•×ª ×©×œ×™</h2>
                <div id="tasksList"></div>
            </div>
        </div>
    </div>

    <script>
        let userData = null;
        let userTasks = [];

        // Check authentication on load
        window.addEventListener('DOMContentLoaded', async () => {
            const authenticated = await checkSession();
            if (!authenticated) {
                window.location.href = 'index.html';
                return;
            }
            await loadDashboard();
        });

        async function checkSession() {
            try {
                const response = await fetch('api.php', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    credentials: 'include',
                    body: JSON.stringify({ action: 'check_session' })
                });
                const data = await response.json();
                return data.authenticated;
            } catch (error) {
                console.error('Session check error:', error);
                return false;
            }
        }

        async function loadDashboard() {
            try {
                // Fetch dashboard data
                const response = await fetch('api.php', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    credentials: 'include',
                    body: JSON.stringify({ action: 'get_dashboard' })
                });

                if (!response.ok) {
                    throw new Error('Failed to load dashboard');
                }

                const data = await response.json();

                if (data.success) {
                    userData = data.user;
                    userTasks = data.tasks || [];

                    renderDashboard();
                } else {
                    throw new Error(data.message || 'Failed to load dashboard');
                }
            } catch (error) {
                console.error('Error loading dashboard:', error);
                document.getElementById('loading').innerHTML = `
                    <p style="color: red;">×©×’×™××” ×‘×˜×¢×™× ×ª ×”× ×ª×•× ×™×</p>
                    <p>${error.message}</p>
                    <button onclick="window.location.href='index.html'" style="padding: 10px 20px; margin-top: 10px;">×—×–×¨×” ×œ×”×ª×—×‘×¨×•×ª</button>
                `;
            }
        }

        function renderDashboard() {
            // Hide loading, show content
            document.getElementById('loading').style.display = 'none';
            document.getElementById('dashboardContent').style.display = 'block';

            // Set user name
            document.getElementById('userName').textContent = userData.tz || '××©×ª××©';

            // Calculate stats
            const total = userTasks.length;
            const completed = userTasks.filter(t => t.status === 'completed' || t.status === 'approved').length;
            const pending = userTasks.filter(t => t.status === 'pending').length;
            const percentage = total > 0 ? Math.round((completed / total) * 100) : 0;

            // Update stats
            document.getElementById('totalTasks').textContent = total;
            document.getElementById('completedTasks').textContent = completed;
            document.getElementById('pendingTasks').textContent = pending;
            document.getElementById('progressPercentage').textContent = percentage + '%';

            // Update progress bar
            const progressBar = document.getElementById('progressBar');
            progressBar.style.width = percentage + '%';
            progressBar.textContent = percentage + '%';

            // Render tasks
            renderTasks();
        }

        function renderTasks() {
            const tasksList = document.getElementById('tasksList');

            if (userTasks.length === 0) {
                tasksList.innerHTML = `
                    <div class="no-tasks">
                        <div class="no-tasks-icon">ğŸ“‹</div>
                        <p>××™×Ÿ ×œ×š ××©×™××•×ª ×›×¨×’×¢</p>
                    </div>
                `;
                return;
            }

            // Sort tasks: pending/in-progress first, then by sequence order
            const sortedTasks = [...userTasks].sort((a, b) => {
                if (a.status === 'completed' && b.status !== 'completed') return 1;
                if (a.status !== 'completed' && b.status === 'completed') return -1;
                return (a.sequence_order || 0) - (b.sequence_order || 0);
            });

            tasksList.innerHTML = sortedTasks.map(task => {
                const statusText = getStatusText(task.status);
                const statusClass = task.status.replace('_', '-');
                const dueDate = task.due_date ? new Date(task.due_date).toLocaleDateString('he-IL') : null;

                return `
                    <div class="task-card ${statusClass}" onclick="openTask(${task.id}, ${task.task_id})">
                        <div class="task-header">
                            <h3 class="task-title">${task.title}</h3>
                            <span class="task-status ${statusClass}">${statusText}</span>
                        </div>
                        ${task.description ? `<p class="task-description">${task.description}</p>` : ''}
                        <div class="task-meta">
                            ${task.estimated_duration ? `
                                <div class="task-meta-item">
                                    <span>â±ï¸</span>
                                    <span>${task.estimated_duration} ×“×§×•×ª</span>
                                </div>
                            ` : ''}
                            ${task.points ? `
                                <div class="task-meta-item">
                                    <span>â­</span>
                                    <span>${task.points} × ×§×•×“×•×ª</span>
                                </div>
                            ` : ''}
                            ${dueDate ? `
                                <div class="task-meta-item">
                                    <span>ğŸ“…</span>
                                    <span>×ª××¨×™×š ×™×¢×“: ${dueDate}</span>
                                </div>
                            ` : ''}
                        </div>
                    </div>
                `;
            }).join('');
        }

        function getStatusText(status) {
            const statusMap = {
                'pending': '×××ª×™× ×”',
                'in_progress': '×‘×ª×”×œ×™×š',
                'completed': '×”×•×©×œ××”',
                'needs_review': '×××ª×™× ×” ×œ×‘×“×™×§×”',
                'approved': '××•×©×¨×”',
                'rejected': '× ×“×—×ª×”'
            };
            return statusMap[status] || status;
        }

        function openTask(userTaskId, taskId) {
            window.location.href = `task.html?id=${userTaskId}`;
        }

        async function logout() {
            try {
                await fetch('api.php', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    credentials: 'include',
                    body: JSON.stringify({ action: 'logout' })
                });
            } catch (error) {
                console.error('Logout error:', error);
            }
            window.location.href = 'index.html';
        }
    </script>
</body>
</html>
