<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>×‘×•× ×” ×˜×¤×¡×™× - ××¢×¨×›×ª × ×™×”×•×œ</title>
    <link rel="stylesheet" href="../../style.css">
    <link rel="stylesheet" href="../admin.css">
    <style>
        .builder-container {
            display: grid;
            grid-template-columns: 300px 1fr;
            gap: 2rem;
            height: calc(100vh - 200px);
        }

        .builder-sidebar {
            background: var(--white);
            border-radius: 12px;
            padding: 1.5rem;
            box-shadow: var(--shadow-sm);
            overflow-y: auto;
        }

        .builder-canvas {
            background: var(--gray-50);
            border-radius: 12px;
            padding: 2rem;
            overflow-y: auto;
        }

        .form-preview {
            background: var(--white);
            border-radius: 12px;
            padding: 2rem;
            max-width: 800px;
            margin: 0 auto;
            box-shadow: var(--shadow-md);
        }

        .section-block {
            background: var(--gray-50);
            border: 2px dashed var(--primary-color);
            border-radius: 8px;
            padding: 1.5rem;
            margin-bottom: 1.5rem;
        }

        .section-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
            padding-bottom: 0.75rem;
            border-bottom: 2px solid var(--primary-color);
        }

        .section-title {
            font-size: 1.25rem;
            font-weight: 700;
            color: var(--primary-color);
        }

        .question-item {
            background: var(--white);
            border: 1px solid var(--gray-200);
            border-radius: 8px;
            padding: 1rem;
            margin-bottom: 0.75rem;
            transition: all 0.2s;
        }

        .question-item:hover {
            box-shadow: var(--shadow-sm);
            border-color: var(--primary-color);
        }

        .question-header {
            display: flex;
            justify-content: space-between;
            align-items: start;
            margin-bottom: 0.5rem;
        }

        .question-controls {
            display: flex;
            gap: 0.25rem;
        }

        .question-controls button {
            padding: 0.25rem 0.5rem;
            font-size: 0.875rem;
            min-width: auto;
        }

        .question-text {
            font-weight: 600;
            margin-bottom: 0.5rem;
        }

        .question-type {
            font-size: 0.875rem;
            color: var(--gray-600);
        }

        .add-item-button {
            width: 100%;
            border: 2px dashed var(--gray-300);
            background: transparent;
            color: var(--gray-600);
            padding: 1rem;
            margin-bottom: 1rem;
            transition: all 0.2s;
        }

        .add-item-button:hover {
            border-color: var(--primary-color);
            color: var(--primary-color);
            background: var(--gray-50);
        }

        .question-type-button {
            width: 100%;
            padding: 0.75rem;
            margin-bottom: 0.5rem;
            text-align: right;
            background: var(--gray-50);
            border: 1px solid var(--gray-200);
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .question-type-button:hover {
            background: var(--primary-color);
            color: var(--white);
            border-color: var(--primary-color);
        }

        .empty-form {
            text-align: center;
            padding: 4rem 2rem;
            color: var(--gray-500);
        }

        .empty-form-icon {
            font-size: 4rem;
            margin-bottom: 1rem;
        }
    </style>
</head>
<body class="admin-body">
    <!-- Sidebar -->
    <aside class="sidebar">
        <div class="sidebar-header">
            <div class="sidebar-logo">ğŸ‘¨â€ğŸ’¼</div>
            <h2>×¤×× ×œ × ×™×”×•×œ</h2>
            <p class="admin-name" id="admin-name">×˜×•×¢×Ÿ...</p>
        </div>

        <nav class="sidebar-nav">
            <a href="../dashboard.html" class="nav-item">
                <span class="nav-icon">ğŸ“Š</span>
                <span>×œ×•×— ×‘×§×¨×”</span>
            </a>
            <a href="../users/" class="nav-item">
                <span class="nav-icon">ğŸ‘¥</span>
                <span>× ×™×”×•×œ ××©×ª××©×™×</span>
            </a>
            <a href="../forms/" class="nav-item active">
                <span class="nav-icon">ğŸ“</span>
                <span>×‘× ×™×™×ª ×˜×¤×¡×™×</span>
            </a>
            <a href="../questions/" class="nav-item">
                <span class="nav-icon">â“</span>
                <span>×¡×¤×¨×™×™×ª ×©××œ×•×ª</span>
            </a>
            <a href="../responses/" class="nav-item">
                <span class="nav-icon">ğŸ“‹</span>
                <span>×¦×¤×™×™×” ×‘×ª×©×•×‘×•×ª</span>
            </a>
            <a href="#" class="nav-item nav-item-danger" onclick="logout()">
                <span class="nav-icon">ğŸšª</span>
                <span>×”×ª× ×ª×§</span>
            </a>
        </nav>

        <div class="sidebar-footer">
            <p>×’×¨×¡×” 1.0</p>
        </div>
    </aside>

    <!-- Main Content -->
    <main class="admin-main">
        <header class="admin-header">
            <div>
                <h1 id="form-title-display">×‘×•× ×” ×˜×¤×¡×™×</h1>
                <p id="form-description-display">×¦×•×¨ ×•×¢×¦×‘ ××ª ×”×˜×•×¤×¡ ×©×œ×š</p>
            </div>
            <div style="display: flex; gap: 1rem;">
                <button class="btn btn-secondary" onclick="window.location.href='./index.html'">
                    <span>â†</span>
                    <span>×—×–×•×¨ ×œ×¨×©×™××”</span>
                </button>
                <button class="btn btn-success" onclick="saveForm()">
                    <span>ğŸ’¾</span>
                    <span>×©××•×¨ ×˜×•×¤×¡</span>
                </button>
            </div>
        </header>

        <!-- Message container -->
        <div id="message-container"></div>

        <!-- Builder -->
        <section class="section">
            <div class="builder-container">
                <!-- Sidebar -->
                <div class="builder-sidebar">
                    <h3 style="margin-bottom: 1rem;">×›×œ×™ ×‘× ×™×™×”</h3>

                    <div style="margin-bottom: 2rem;">
                        <h4 style="font-size: 0.875rem; color: var(--gray-600); margin-bottom: 0.5rem;">×”×’×“×¨×•×ª ×˜×•×¤×¡</h4>
                        <button class="btn btn-secondary" onclick="editFormDetails()" style="width: 100%; margin-bottom: 0.5rem;">
                            âš™ï¸ ×¢×¨×•×š ×¤×¨×˜×™ ×˜×•×¤×¡
                        </button>
                        <button class="btn btn-secondary" onclick="addSection()" style="width: 100%;">
                            ğŸ“‘ ×”×•×¡×£ ×§×˜×’×•×¨×™×”
                        </button>
                    </div>

                    <div>
                        <h4 style="font-size: 0.875rem; color: var(--gray-600); margin-bottom: 0.5rem;">×¡×•×’×™ ×©××œ×•×ª</h4>
                        <div id="question-types-list">
                            <!-- Will be populated by JS -->
                        </div>
                    </div>
                </div>

                <!-- Canvas -->
                <div class="builder-canvas">
                    <div class="form-preview" id="form-canvas">
                        <div class="empty-form">
                            <div class="empty-form-icon">ğŸ“</div>
                            <h3>×”×ª×—×œ ×œ×‘× ×•×ª ××ª ×”×˜×•×¤×¡</h3>
                            <p>×”×•×¡×£ ×§×˜×’×•×¨×™×•×ª ××• ×©××œ×•×ª ×›×“×™ ×œ×”×ª×—×™×œ</p>
                        </div>
                    </div>
                </div>
            </div>
        </section>
    </main>

    <script src="../admin.js"></script>
    <script>
        let currentFormId = null;
        let questionTypes = [];
        let formStructure = {
            sections: [],
            questions: []
        };
        let currentSection = null; // For adding questions to a section

        // Get form ID from URL
        const urlParams = new URLSearchParams(window.location.search);
        const formIdParam = urlParams.get('form_id');

        // Load on page load
        window.addEventListener('DOMContentLoaded', async () => {
            await loadQuestionTypes();

            if (formIdParam) {
                await loadForm(formIdParam);
            } else {
                // Create new form
                showFormDetailsModal(true);
            }
        });

        // Load question types
        async function loadQuestionTypes() {
            try {
                const data = await apiRequest('get_question_types');
                if (data && data.success) {
                    questionTypes = data.types;
                    renderQuestionTypesButtons();
                }
            } catch (error) {
                console.error('Error loading question types:', error);
            }
        }

        // Render question type buttons
        function renderQuestionTypesButtons() {
            const container = document.getElementById('question-types-list');
            container.innerHTML = questionTypes.map(type => `
                <button class="question-type-button" onclick="addQuestion(${type.id}, '${escapeHtml(type.type_name)}')">
                    ${escapeHtml(type.type_name)}
                </button>
            `).join('');
        }

        // Load existing form
        async function loadForm(formId) {
            try {
                const data = await apiRequest('get_form', { form_id: formId });
                if (!data || !data.success) {
                    showError('×©×’×™××” ×‘×˜×¢×™× ×ª ×˜×•×¤×¡');
                    return;
                }

                currentFormId = formId;
                const form = data.form;
                const questions = data.questions || [];

                // Update header
                document.getElementById('form-title-display').textContent = form.title;
                document.getElementById('form-description-display').textContent = form.description || '×¢×¨×•×š ××ª ×”×˜×•×¤×¡ ×©×œ×š';

                // Parse structure
                parseFormStructure(questions);
                renderFormCanvas();

            } catch (error) {
                console.error('Error loading form:', error);
                showError('×©×’×™××” ×‘×˜×¢×™× ×ª ×˜×•×¤×¡');
            }
        }

        // Parse form structure from questions
        function parseFormStructure(questions) {
            formStructure = { sections: [], questions: [] };

            // Group by section
            const sectionsMap = new Map();
            const noSectionQuestions = [];

            questions.forEach(q => {
                if (q.section_title) {
                    if (!sectionsMap.has(q.section_title)) {
                        sectionsMap.set(q.section_title, {
                            title: q.section_title,
                            sequence: q.section_sequence || 0,
                            questions: []
                        });
                    }
                    sectionsMap.get(q.section_title).questions.push(q);
                } else {
                    noSectionQuestions.push(q);
                }
            });

            // Convert to array and sort
            formStructure.sections = Array.from(sectionsMap.values())
                .sort((a, b) => a.sequence - b.sequence);

            // Sort questions within sections
            formStructure.sections.forEach(section => {
                section.questions.sort((a, b) => a.sequence_order - b.sequence_order);
            });

            // Sort questions without section
            formStructure.questions = noSectionQuestions.sort((a, b) => a.sequence_order - b.sequence_order);
        }

        // Render form canvas
        function renderFormCanvas() {
            const canvas = document.getElementById('form-canvas');

            if (formStructure.sections.length === 0 && formStructure.questions.length === 0) {
                canvas.innerHTML = `
                    <div class="empty-form">
                        <div class="empty-form-icon">ğŸ“</div>
                        <h3>×”×ª×—×œ ×œ×‘× ×•×ª ××ª ×”×˜×•×¤×¡</h3>
                        <p>×”×•×¡×£ ×§×˜×’×•×¨×™×•×ª ××• ×©××œ×•×ª ×›×“×™ ×œ×”×ª×—×™×œ</p>
                    </div>
                `;
                return;
            }

            let html = '';

            // Render sections
            formStructure.sections.forEach((section, sectionIndex) => {
                html += `
                    <div class="section-block">
                        <div class="section-header">
                            <div class="section-title">${escapeHtml(section.title)}</div>
                            <div style="display: flex; gap: 0.5rem;">
                                ${sectionIndex > 0 ? `<button class="btn btn-sm btn-secondary" onclick="moveSectionUp(${sectionIndex})">â†‘</button>` : ''}
                                ${sectionIndex < formStructure.sections.length - 1 ? `<button class="btn btn-sm btn-secondary" onclick="moveSectionDown(${sectionIndex})">â†“</button>` : ''}
                                <button class="btn btn-sm btn-secondary" onclick="editSection(${sectionIndex})">âœï¸</button>
                                <button class="btn btn-sm btn-danger" onclick="removeSection(${sectionIndex})">ğŸ—‘ï¸</button>
                            </div>
                        </div>

                        ${section.questions.map((q, qIndex) => renderQuestionItem(q, qIndex, sectionIndex)).join('')}

                        <button class="add-item-button" onclick="selectSectionForQuestion(${sectionIndex})">
                            + ×”×•×¡×£ ×©××œ×” ×œ×§×˜×’×•×¨×™×” ×–×•
                        </button>
                    </div>
                `;
            });

            // Render questions without section
            if (formStructure.questions.length > 0 || formStructure.sections.length === 0) {
                html += `<div style="margin-top: 1.5rem;">`;
                if (formStructure.questions.length > 0) {
                    html += `<h3 style="margin-bottom: 1rem; color: var(--gray-700);">×©××œ×•×ª ×œ×œ× ×§×˜×’×•×¨×™×”</h3>`;
                }
                html += formStructure.questions.map((q, qIndex) => renderQuestionItem(q, qIndex, null)).join('');
                html += `</div>`;
            }

            canvas.innerHTML = html;
        }

        // Render single question item
        function renderQuestionItem(question, index, sectionIndex) {
            const inSection = sectionIndex !== null;
            const list = inSection ? formStructure.sections[sectionIndex].questions : formStructure.questions;

            return `
                <div class="question-item">
                    <div class="question-header">
                        <div style="flex: 1;">
                            <div class="question-text">
                                ${index + 1}. ${escapeHtml(question.question_text)}
                                ${question.is_required ? '<span style="color: var(--danger-color);">*</span>' : ''}
                            </div>
                            <div class="question-type">
                                ${escapeHtml(question.type_name)}
                                ${question.placeholder ? ` â€¢ ${escapeHtml(question.placeholder)}` : ''}
                            </div>
                        </div>
                        <div class="question-controls">
                            ${index > 0 ? `<button class="btn btn-sm btn-secondary" onclick="moveQuestionUp(${index}, ${inSection}, ${sectionIndex})">â†‘</button>` : ''}
                            ${index < list.length - 1 ? `<button class="btn btn-sm btn-secondary" onclick="moveQuestionDown(${index}, ${inSection}, ${sectionIndex})">â†“</button>` : ''}
                            <button class="btn btn-sm btn-secondary" onclick="editQuestion(${question.id})">âœï¸</button>
                            <button class="btn btn-sm btn-danger" onclick="removeQuestion(${question.id})">ğŸ—‘ï¸</button>
                        </div>
                    </div>
                </div>
            `;
        }

        // Add section
        function addSection() {
            showModal('×”×•×¡×£ ×§×˜×’×•×¨×™×”', `
                <form id="section-form">
                    <div class="form-group">
                        <label class="form-label">×©× ×”×§×˜×’×•×¨×™×” *</label>
                        <input type="text" id="section-title" class="form-input" required placeholder="×œ×“×•×’××”: ×¤×¨×˜×™× ××™×©×™×™×">
                    </div>
                </form>
            `, [
                { text: '×‘×˜×œ', class: 'btn-secondary', onclick: 'closeModal()' },
                { text: '×”×•×¡×£', class: 'btn-primary', onclick: 'saveSectionTitle()' }
            ]);
        }

        // Save section title
        function saveSectionTitle() {
            const title = document.getElementById('section-title').value.trim();
            if (!title) {
                showError('× × ×œ×”×–×™×Ÿ ×©× ×§×˜×’×•×¨×™×”');
                return;
            }

            formStructure.sections.push({
                title: title,
                sequence: formStructure.sections.length,
                questions: []
            });

            renderFormCanvas();
            closeModal();
            showSuccess('×§×˜×’×•×¨×™×” × ×•×¡×¤×” ×‘×”×¦×œ×—×”');
        }

        // Select section for adding question
        function selectSectionForQuestion(sectionIndex) {
            currentSection = sectionIndex;
            // Show question types or directly add based on type selection
            showMessage('×‘×—×¨ ×¡×•×’ ×©××œ×” ××”×¡×¨×’×œ ×”×™×× ×™', 'info');
        }

        // Add question
        function addQuestion(typeId, typeName) {
            showModal('×”×•×¡×£ ×©××œ×”', `
                <form id="question-form">
                    <div class="form-group">
                        <label class="form-label">×¡×•×’ ×©××œ×”</label>
                        <input type="text" class="form-input" value="${typeName}" disabled>
                    </div>

                    <div class="form-group">
                        <label class="form-label">×˜×§×¡×˜ ×”×©××œ×” *</label>
                        <input type="text" id="question-text" class="form-input" required placeholder="×œ×“×•×’××”: ××”×• ×©××š ×”××œ×?">
                    </div>

                    <div class="form-group">
                        <label class="form-label">×˜×§×¡×˜ ×¢×–×¨ (Placeholder)</label>
                        <input type="text" id="question-placeholder" class="form-input" placeholder="×˜×§×¡×˜ ×©×™×•×¦×’ ×‘×©×“×” ×”×¨×™×§">
                    </div>

                    <div class="form-group" id="options-group" style="display: none;">
                        <label class="form-label">××¤×©×¨×•×™×•×ª (××—×ª ×‘×›×œ ×©×•×¨×”)</label>
                        <textarea id="question-options" class="form-textarea" placeholder="××¤×©×¨×•×ª 1&#10;××¤×©×¨×•×ª 2&#10;××¤×©×¨×•×ª 3"></textarea>
                    </div>

                    <div class="form-group">
                        <label style="display: flex; align-items: center; gap: 0.5rem;">
                            <input type="checkbox" id="question-required" checked>
                            <span>×©×“×” × ×“×¨×©</span>
                        </label>
                    </div>

                    ${currentSection !== null ?
                        `<div class="alert alert-info">×©××œ×” ×–×• ×ª×ª×•×•×¡×£ ×œ×§×˜×’×•×¨×™×”: ${escapeHtml(formStructure.sections[currentSection].title)}</div>` :
                        `<div class="alert alert-info">×©××œ×” ×–×• ×ª×ª×•×•×¡×£ ×œ×œ× ×§×˜×’×•×¨×™×”</div>`
                    }
                </form>
            `, [
                { text: '×‘×˜×œ', class: 'btn-secondary', onclick: 'closeModal(); currentSection = null;' },
                { text: '×”×•×¡×£ ×©××œ×”', class: 'btn-primary', onclick: `saveQuestion(${typeId})` }
            ]);

            // Show options field for certain types
            const type = questionTypes.find(t => t.id === typeId);
            if (type && (type.type_code === 'radio' || type.type_code === 'checkbox' || type.type_code === 'select')) {
                document.getElementById('options-group').style.display = 'block';
            }
        }

        // Save question
        async function saveQuestion(typeId) {
            if (!currentFormId) {
                showError('× × ×œ×™×¦×•×¨ ×˜×•×¤×¡ ×ª×—×™×œ×”');
                return;
            }

            const questionText = document.getElementById('question-text').value.trim();
            const placeholder = document.getElementById('question-placeholder').value.trim();
            const isRequired = document.getElementById('question-required').checked ? 1 : 0;

            let options = null;
            const optionsTextarea = document.getElementById('question-options');
            if (optionsTextarea && optionsTextarea.style.display !== 'none') {
                const optionsText = optionsTextarea.value.trim();
                if (optionsText) {
                    options = JSON.stringify(optionsText.split('\n').filter(o => o.trim()));
                }
            }

            if (!questionText) {
                showError('× × ×œ×”×–×™×Ÿ ×˜×§×¡×˜ ×©××œ×”');
                return;
            }

            // Determine section info
            let sectionTitle = null;
            let sectionSequence = 0;
            let sequence = 0;

            if (currentSection !== null) {
                const section = formStructure.sections[currentSection];
                sectionTitle = section.title;
                sectionSequence = section.sequence;
                sequence = section.questions.length;
            } else {
                sequence = formStructure.questions.length;
            }

            try {
                const result = await apiRequest('add_question_to_form', {
                    form_id: currentFormId,
                    question_text: questionText,
                    question_type_id: typeId,
                    section_title: sectionTitle,
                    section_sequence: sectionSequence,
                    sequence: sequence,
                    is_required: isRequired,
                    placeholder: placeholder || null,
                    options: options
                }, 'POST');

                if (result.success) {
                    showSuccess('×©××œ×” × ×•×¡×¤×” ×‘×”×¦×œ×—×”');
                    closeModal();
                    currentSection = null;
                    await loadForm(currentFormId); // Reload form
                } else {
                    showError(result.message || '×©×’×™××” ×‘×”×•×¡×¤×ª ×©××œ×”');
                }
            } catch (error) {
                console.error('Error adding question:', error);
                showError('×©×’×™××” ×‘×”×•×¡×¤×ª ×©××œ×”');
            }
        }

        // Move section up
        function moveSectionUp(index) {
            if (index > 0) {
                [formStructure.sections[index], formStructure.sections[index - 1]] =
                [formStructure.sections[index - 1], formStructure.sections[index]];
                renderFormCanvas();
            }
        }

        // Move section down
        function moveSectionDown(index) {
            if (index < formStructure.sections.length - 1) {
                [formStructure.sections[index], formStructure.sections[index + 1]] =
                [formStructure.sections[index + 1], formStructure.sections[index]];
                renderFormCanvas();
            }
        }

        // Move question up
        function moveQuestionUp(index, inSection, sectionIndex) {
            const list = inSection ? formStructure.sections[sectionIndex].questions : formStructure.questions;
            if (index > 0) {
                [list[index], list[index - 1]] = [list[index - 1], list[index]];
                renderFormCanvas();
            }
        }

        // Move question down
        function moveQuestionDown(index, inSection, sectionIndex) {
            const list = inSection ? formStructure.sections[sectionIndex].questions : formStructure.questions;
            if (index < list.length - 1) {
                [list[index], list[index + 1]] = [list[index + 1], list[index]];
                renderFormCanvas();
            }
        }

        // Remove question
        async function removeQuestion(formQuestionId) {
            if (!confirm('×”×× ××ª×” ×‘×˜×•×— ×©×‘×¨×¦×•× ×š ×œ××—×•×§ ×©××œ×” ×–×•?')) {
                return;
            }

            try {
                const result = await apiRequest('remove_question_from_form', {
                    form_question_id: formQuestionId
                }, 'POST');

                if (result.success) {
                    showSuccess('×©××œ×” ×”×•×¡×¨×” ×‘×”×¦×œ×—×”');
                    await loadForm(currentFormId);
                } else {
                    showError(result.message || '×©×’×™××” ×‘×”×¡×¨×ª ×©××œ×”');
                }
            } catch (error) {
                console.error('Error removing question:', error);
                showError('×©×’×™××” ×‘×”×¡×¨×ª ×©××œ×”');
            }
        }

        // Remove section
        function removeSection(index) {
            if (!confirm('×”×× ××ª×” ×‘×˜×•×—? ×©××œ×•×ª ×‘×§×˜×’×•×¨×™×” ×–×• ×™×•×¢×‘×¨×• ×œ×—×œ×§ ×œ×œ× ×§×˜×’×•×¨×™×”')) {
                return;
            }

            // Move questions to no-section
            const section = formStructure.sections[index];
            formStructure.questions.push(...section.questions);
            formStructure.sections.splice(index, 1);
            renderFormCanvas();
        }

        // Edit form details
        function editFormDetails() {
            const form = {
                title: document.getElementById('form-title-display').textContent,
                description: document.getElementById('form-description-display').textContent
            };

            showFormDetailsModal(false, form);
        }

        // Show form details modal
        function showFormDetailsModal(isNew = false, form = null) {
            showModal(isNew ? '×¦×•×¨ ×˜×•×¤×¡ ×—×“×©' : '×¢×¨×•×š ×¤×¨×˜×™ ×˜×•×¤×¡', `
                <form id="form-details-form">
                    <div class="form-group">
                        <label class="form-label">×›×•×ª×¨×ª ×”×˜×•×¤×¡ *</label>
                        <input type="text" id="form-title-input" class="form-input" required
                               placeholder="×œ×“×•×’××”: ×˜×•×¤×¡ ×§×‘×œ×” ×œ×§×•×¨×¡" value="${form ? escapeHtml(form.title) : ''}">
                    </div>

                    <div class="form-group">
                        <label class="form-label">×ª×™××•×¨</label>
                        <textarea id="form-description-input" class="form-textarea"
                                  placeholder="×ª×™××•×¨ ×§×¦×¨ ×©×œ ×”×˜×•×¤×¡...">${form ? escapeHtml(form.description) : ''}</textarea>
                    </div>
                </form>
            `, [
                { text: '×‘×˜×œ', class: 'btn-secondary', onclick: isNew ? 'window.location.href="./index.html"' : 'closeModal()' },
                { text: isNew ? '×¦×•×¨ ×˜×•×¤×¡' : '×©××•×¨', class: 'btn-primary', onclick: `saveFormDetails(${isNew})` }
            ]);
        }

        // Save form details
        async function saveFormDetails(isNew) {
            const title = document.getElementById('form-title-input').value.trim();
            const description = document.getElementById('form-description-input').value.trim();

            if (!title) {
                showError('× × ×œ×”×–×™×Ÿ ×›×•×ª×¨×ª');
                return;
            }

            if (isNew) {
                try {
                    const result = await apiRequest('create_form', {
                        title: title,
                        description: description
                    }, 'POST');

                    if (result.success) {
                        currentFormId = result.form_id;
                        document.getElementById('form-title-display').textContent = title;
                        document.getElementById('form-description-display').textContent = description || '×¢×¨×•×š ××ª ×”×˜×•×¤×¡ ×©×œ×š';
                        closeModal();
                        showSuccess('×˜×•×¤×¡ × ×•×¦×¨ ×‘×”×¦×œ×—×”! ×›×¢×ª × ×™×ª×Ÿ ×œ×”×•×¡×™×£ ×©××œ×•×ª');
                        renderFormCanvas();
                    } else {
                        showError(result.message || '×©×’×™××” ×‘×™×¦×™×¨×ª ×˜×•×¤×¡');
                    }
                } catch (error) {
                    console.error('Error creating form:', error);
                    showError('×©×’×™××” ×‘×™×¦×™×¨×ª ×˜×•×¤×¡');
                }
            } else {
                // Update form details (would need an API endpoint)
                document.getElementById('form-title-display').textContent = title;
                document.getElementById('form-description-display').textContent = description || '×¢×¨×•×š ××ª ×”×˜×•×¤×¡ ×©×œ×š';
                closeModal();
                showSuccess('×¤×¨×˜×™ ×˜×•×¤×¡ ×¢×•×“×›× ×•');
            }
        }

        // Save form (update sequences)
        async function saveForm() {
            if (!currentFormId) {
                showError('××™×Ÿ ×˜×•×¤×¡ ×œ×©××•×¨');
                return;
            }

            // Build structure array
            const structure = [];

            // Add sections and their questions
            formStructure.sections.forEach((section, sIndex) => {
                section.questions.forEach((q, qIndex) => {
                    structure.push({
                        id: q.id,
                        section_title: section.title,
                        section_sequence: sIndex,
                        sequence: qIndex
                    });
                });
            });

            // Add questions without section
            formStructure.questions.forEach((q, qIndex) => {
                structure.push({
                    id: q.id,
                    section_title: null,
                    section_sequence: 0,
                    sequence: qIndex
                });
            });

            try {
                const result = await apiRequest('reorder_form_structure', {
                    form_id: currentFormId,
                    structure: structure
                }, 'POST');

                if (result.success) {
                    showSuccess('×˜×•×¤×¡ × ×©××¨ ×‘×”×¦×œ×—×”!');
                } else {
                    showError(result.message || '×©×’×™××” ×‘×©××™×¨×ª ×˜×•×¤×¡');
                }
            } catch (error) {
                console.error('Error saving form:', error);
                showError('×©×’×™××” ×‘×©××™×¨×ª ×˜×•×¤×¡');
            }
        }

        // Edit section (rename)
        function editSection(index) {
            const section = formStructure.sections[index];
            showModal('×¢×¨×•×š ×§×˜×’×•×¨×™×”', `
                <form>
                    <div class="form-group">
                        <label class="form-label">×©× ×”×§×˜×’×•×¨×™×” *</label>
                        <input type="text" id="edit-section-title" class="form-input" required value="${escapeHtml(section.title)}">
                    </div>
                </form>
            `, [
                { text: '×‘×˜×œ', class: 'btn-secondary', onclick: 'closeModal()' },
                { text: '×©××•×¨', class: 'btn-primary', onclick: `updateSectionTitle(${index})` }
            ]);
        }

        // Update section title
        function updateSectionTitle(index) {
            const newTitle = document.getElementById('edit-section-title').value.trim();
            if (!newTitle) {
                showError('× × ×œ×”×–×™×Ÿ ×©× ×§×˜×’×•×¨×™×”');
                return;
            }

            formStructure.sections[index].title = newTitle;
            renderFormCanvas();
            closeModal();
            showSuccess('×§×˜×’×•×¨×™×” ×¢×•×“×›× ×”');
        }

        // Edit question
        function editQuestion(questionId) {
            showError('×¢×¨×™×›×ª ×©××œ×” ×ª×”×™×” ×–××™× ×” ×‘×§×¨×•×‘. ×›×¨×’×¢ × ×™×ª×Ÿ ×œ××—×•×§ ×•×œ×”×•×¡×™×£ ××—×“×©.');
            // TODO: Implement edit question
        }
    </script>
</body>
</html>
