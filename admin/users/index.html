<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>× ×™×”×•×œ ××©×ª××©×™× - ××¢×¨×›×ª × ×™×”×•×œ</title>
    <link rel="stylesheet" href="../../style.css">
    <link rel="stylesheet" href="../admin.css">
</head>
<body class="admin-body">
    <!-- Sidebar -->
    <aside class="sidebar">
        <div class="sidebar-header">
            <div class="sidebar-logo">ğŸ‘¨â€ğŸ’¼</div>
            <h2>×¤×× ×œ × ×™×”×•×œ</h2>
            <p class="admin-name" id="admin-name">×˜×•×¢×Ÿ...</p>
        </div>

        <nav class="sidebar-nav">
            <a href="../dashboard.html" class="nav-item">
                <span class="nav-icon">ğŸ“Š</span>
                <span>×œ×•×— ×‘×§×¨×”</span>
            </a>
            <a href="../users/" class="nav-item active">
                <span class="nav-icon">ğŸ‘¥</span>
                <span>× ×™×”×•×œ ××©×ª××©×™×</span>
            </a>
            <a href="../forms/" class="nav-item">
                <span class="nav-icon">ğŸ“</span>
                <span>×‘× ×™×™×ª ×˜×¤×¡×™×</span>
            </a>
            <a href="../questions/" class="nav-item">
                <span class="nav-icon">â“</span>
                <span>×¡×¤×¨×™×™×ª ×©××œ×•×ª</span>
            </a>
            <a href="../responses/" class="nav-item">
                <span class="nav-icon">ğŸ“‹</span>
                <span>×¦×¤×™×™×” ×‘×ª×©×•×‘×•×ª</span>
            </a>
            <a href="#" class="nav-item nav-item-danger" onclick="logout()">
                <span class="nav-icon">ğŸšª</span>
                <span>×”×ª× ×ª×§</span>
            </a>
        </nav>

        <div class="sidebar-footer">
            <p>×’×¨×¡×” 1.0</p>
        </div>
    </aside>

    <!-- Main Content -->
    <main class="admin-main">
        <header class="admin-header">
            <h1>× ×™×”×•×œ ××©×ª××©×™×</h1>
            <p>×”×•×¡×£, ×¢×¨×•×š ×•×”×¡×¨ ××©×ª××©×™× ××”××¢×¨×›×ª</p>
        </header>

        <!-- Message container -->
        <div id="message-container"></div>

        <!-- Toolbar -->
        <section class="section">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem;">
                <div style="display: flex; gap: 1rem;">
                    <button class="btn btn-primary" onclick="showCreateUserModal()">
                        <span>â•</span>
                        <span>×”×•×¡×£ ××©×ª××©</span>
                    </button>
                    <button class="btn btn-secondary" onclick="showBulkImportModal()">
                        <span>ğŸ“¥</span>
                        <span>×™×™×‘×•× ××¨×•×‘×”</span>
                    </button>
                </div>
                <div style="display: flex; gap: 1rem; align-items: center;">
                    <input
                        type="text"
                        id="search-input"
                        class="form-input"
                        placeholder="×—×¤×© ×œ×¤×™ ×ª.×–. ××• ×©×..."
                        style="width: 300px;"
                        onkeyup="handleSearch(event)"
                    >
                    <button class="btn btn-secondary" onclick="loadUsers()">
                        <span>ğŸ”„</span>
                        <span>×¨×¢× ×Ÿ</span>
                    </button>
                </div>
            </div>

            <!-- Users Table -->
            <div class="table-container">
                <table class="data-table">
                    <thead>
                        <tr>
                            <th>×ª.×–.</th>
                            <th>×©× ××œ×</th>
                            <th>×˜×•×¤×¡ ××©×•×™×™×š</th>
                            <th>×©××œ×•×ª ×©×¢× ×”</th>
                            <th>×¡×˜×˜×•×¡</th>
                            <th>×ª××¨×™×š ×™×¦×™×¨×”</th>
                            <th>×¤×¢×•×œ×•×ª</th>
                        </tr>
                    </thead>
                    <tbody id="users-table-body">
                        <tr>
                            <td colspan="7" class="text-center">×˜×•×¢×Ÿ ××©×ª××©×™×...</td>
                        </tr>
                    </tbody>
                </table>
            </div>

            <!-- Pagination -->
            <div id="pagination-container"></div>
        </section>
    </main>

    <script src="../admin.js"></script>
    <script>
        let currentPage = 1;
        let currentSearch = '';

        // Load users on page load
        window.addEventListener('DOMContentLoaded', () => {
            loadUsers();
        });

        // Load users
        async function loadUsers(page = 1) {
            currentPage = page;
            showLoading('users-table-body');

            try {
                const data = await apiRequest('list_users', {
                    page: page,
                    search: currentSearch
                });

                if (!data || !data.success) {
                    document.getElementById('users-table-body').innerHTML =
                        renderEmptyTable('×©×’×™××” ×‘×˜×¢×™× ×ª ××©×ª××©×™×', 7);
                    return;
                }

                renderUsers(data.users);
                renderPaginationControls(data.pagination);

            } catch (error) {
                console.error('Error loading users:', error);
                document.getElementById('users-table-body').innerHTML =
                    renderEmptyTable('×©×’×™××” ×‘×˜×¢×™× ×ª ××©×ª××©×™×', 7);
            }
        }

        // Render users table
        function renderUsers(users) {
            const tbody = document.getElementById('users-table-body');

            if (!users || users.length === 0) {
                tbody.innerHTML = renderEmptyTable('×œ× × ××¦××• ××©×ª××©×™×', 7);
                return;
            }

            tbody.innerHTML = users.map(user => `
                <tr>
                    <td><strong>${escapeHtml(user.tz)}</strong></td>
                    <td>${escapeHtml(user.full_name || '-')}</td>
                    <td>${escapeHtml(user.assigned_form || '×œ× ×©×•×™×™×š')}</td>
                    <td>${user.answered_questions || 0}</td>
                    <td>
                        ${user.is_active == 1
                            ? '<span class="badge badge-success">×¤×¢×™×œ</span>'
                            : '<span class="badge badge-danger">×œ× ×¤×¢×™×œ</span>'}
                    </td>
                    <td>${formatDateOnly(user.created_at)}</td>
                    <td>
                        <button class="btn btn-secondary" onclick="showEditUserModal(${user.id})" style="padding: 0.375rem 0.75rem;">
                            âœï¸
                        </button>
                        <button class="btn btn-danger" onclick="deleteUser(${user.id}, '${escapeHtml(user.tz)}')" style="padding: 0.375rem 0.75rem;">
                            ğŸ—‘ï¸
                        </button>
                    </td>
                </tr>
            `).join('');
        }

        // Render pagination
        function renderPaginationControls(pagination) {
            const container = document.getElementById('pagination-container');

            if (!pagination || pagination.pages <= 1) {
                container.innerHTML = '';
                return;
            }

            let html = '<div class="pagination">';

            // Previous button
            if (pagination.page > 1) {
                html += `<button class="btn btn-secondary" onclick="loadUsers(${pagination.page - 1})">â† ×§×•×“×</button>`;
            }

            // Page info
            html += `<span class="pagination-info">×¢××•×“ ${pagination.page} ××ª×•×š ${pagination.pages} (${pagination.total} ××©×ª××©×™×)</span>`;

            // Next button
            if (pagination.page < pagination.pages) {
                html += `<button class="btn btn-secondary" onclick="loadUsers(${pagination.page + 1})">×”×‘× â†’</button>`;
            }

            html += '</div>';
            container.innerHTML = html;
        }

        // Handle search
        function handleSearch(event) {
            if (event.key === 'Enter' || event.type === 'click') {
                currentSearch = document.getElementById('search-input').value.trim();
                loadUsers(1);
            }
        }

        // Show create user modal
        async function showCreateUserModal() {
            // Load forms first
            const formsData = await apiRequest('list_forms');
            const forms = formsData.success ? formsData.forms : [];

            const formsOptions = forms.map(form =>
                `<option value="${form.id}">${escapeHtml(form.title)}</option>`
            ).join('');

            showModal('×”×•×¡×£ ××©×ª××© ×—×“×©', `
                <form id="create-user-form">
                    <div class="form-group">
                        <label class="form-label">×¡×•×’ ××©×ª××© *</label>
                        <select id="new-user-type" class="form-select" onchange="togglePasswordField()">
                            <option value="regular">××©×ª××© ×¨×’×™×œ</option>
                            <option value="admin">××©×ª××© ×× ×”×œ</option>
                        </select>
                        <small style="color: var(--gray-600); font-size: 0.875rem;">××©×ª××© ×¨×’×™×œ ×œ× ×“×•×¨×© ×¡×™×¡××”</small>
                    </div>

                    <div class="form-group">
                        <label class="form-label">×¡×•×’ ××–×”×” *</label>
                        <select id="new-id-type" class="form-select" onchange="updateIdPlaceholder()">
                            <option value="tz">×ª×¢×•×“×ª ×–×”×•×ª (9 ×¡×¤×¨×•×ª)</option>
                            <option value="personal_number">××¡×¤×¨ ××™×©×™ (7 ×¡×¤×¨×•×ª)</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label class="form-label" id="id-label">×ª×¢×•×“×ª ×–×”×•×ª *</label>
                        <input type="text" id="new-tz" class="form-input" required maxlength="9" placeholder="123456789">
                        <small style="color: var(--gray-600); font-size: 0.875rem;" id="id-help">×”×–×Ÿ 9 ×¡×¤×¨×•×ª</small>
                    </div>

                    <div class="form-group">
                        <label class="form-label">×©× ××œ×</label>
                        <input type="text" id="new-fullname" class="form-input" placeholder="×©× ×¤×¨×˜×™ ×•×©× ××©×¤×—×”">
                    </div>

                    <div class="form-group" id="password-group" style="display: none;">
                        <label class="form-label">×¡×™×¡××” *</label>
                        <input type="password" id="new-password" class="form-input" minlength="6" placeholder="×œ×¤×—×•×ª 6 ×ª×•×•×™×">
                    </div>

                    <div class="form-group">
                        <label class="form-label">×©×™×™×š ×œ×˜×•×¤×¡</label>
                        <select id="new-form" class="form-select">
                            <option value="">×œ×œ× ×˜×•×¤×¡</option>
                            ${formsOptions}
                        </select>
                    </div>
                </form>
            `, [
                {
                    text: '×‘×˜×œ',
                    class: 'btn-secondary',
                    onclick: 'closeModal()'
                },
                {
                    text: '×¦×•×¨ ××©×ª××©',
                    class: 'btn-primary',
                    onclick: 'createUser()'
                }
            ]);
        }

        // Toggle password field based on user type
        function togglePasswordField() {
            const userType = document.getElementById('new-user-type').value;
            const passwordGroup = document.getElementById('password-group');
            const passwordInput = document.getElementById('new-password');

            if (userType === 'admin') {
                passwordGroup.style.display = 'block';
                passwordInput.required = true;
            } else {
                passwordGroup.style.display = 'none';
                passwordInput.required = false;
                passwordInput.value = '';
            }
        }

        // Update ID field based on ID type
        function updateIdPlaceholder() {
            const idType = document.getElementById('new-id-type').value;
            const idInput = document.getElementById('new-tz');
            const idLabel = document.getElementById('id-label');
            const idHelp = document.getElementById('id-help');

            if (idType === 'personal_number') {
                idLabel.textContent = '××¡×¤×¨ ××™×©×™ *';
                idInput.placeholder = '1234567';
                idInput.maxLength = 7;
                idHelp.textContent = '×”×–×Ÿ 7 ×¡×¤×¨×•×ª';
            } else {
                idLabel.textContent = '×ª×¢×•×“×ª ×–×”×•×ª *';
                idInput.placeholder = '123456789';
                idInput.maxLength = 9;
                idHelp.textContent = '×”×–×Ÿ 9 ×¡×¤×¨×•×ª';
            }
            idInput.value = ''; // Clear current value when switching types
        }

        // Create user
        async function createUser() {
            const tz = document.getElementById('new-tz').value.trim();
            const idType = document.getElementById('new-id-type').value;
            const fullName = document.getElementById('new-fullname').value.trim();
            const userType = document.getElementById('new-user-type').value;
            const password = document.getElementById('new-password').value;
            const formId = document.getElementById('new-form').value;

            // Validate
            if (!tz) {
                showError('× × ×œ××œ× ××¡×¤×¨ ×–×”×•×™');
                return;
            }

            if (userType === 'admin' && !password) {
                showError('×¡×™×¡××” × ×“×¨×©×ª ×œ××©×ª××© ×× ×”×œ');
                return;
            }

            // Validate based on ID type
            const expectedLength = idType === 'personal_number' ? 7 : 9;
            const idTypeName = idType === 'personal_number' ? '××¡×¤×¨ ××™×©×™' : '×ª×¢×•×“×ª ×–×”×•×ª';

            if (tz.length !== expectedLength || !/^\d+$/.test(tz)) {
                showError(`${idTypeName} ×—×™×™×‘ ×œ×”×™×•×ª ${expectedLength} ×¡×¤×¨×•×ª`);
                return;
            }

            if (password && password.length < 6) {
                showError('×¡×™×¡××” ×—×™×™×‘×ª ×œ×”×™×•×ª ×œ×¤×—×•×ª 6 ×ª×•×•×™×');
                return;
            }

            try {
                const result = await apiRequest('create_user', {
                    tz: tz,
                    id_type: idType,
                    full_name: fullName,
                    user_type: userType,
                    password: password,
                    form_id: formId || null
                }, 'POST');

                if (result.success) {
                    showSuccess('××©×ª××© × ×•×¦×¨ ×‘×”×¦×œ×—×”!');
                    closeModal();
                    loadUsers(currentPage);
                } else {
                    showError(result.message || '×©×’×™××” ×‘×™×¦×™×¨×ª ××©×ª××©');
                }
            } catch (error) {
                console.error('Error creating user:', error);
                showError('×©×’×™××” ×‘×™×¦×™×¨×ª ××©×ª××©');
            }
        }

        // Show bulk import modal
        async function showBulkImportModal() {
            // Load forms first
            const formsData = await apiRequest('list_forms');
            const forms = formsData.success ? formsData.forms : [];

            const formsOptions = forms.map(form =>
                `<option value="${form.id}">${escapeHtml(form.title)}</option>`
            ).join('');

            showModal('×™×™×‘×•× ××¨×•×‘×” ×©×œ ××©×ª××©×™×', `
                <form id="bulk-import-form">
                    <div class="form-group">
                        <label class="form-label">×¡×•×’ ××©×ª××© *</label>
                        <select id="bulk-user-type" class="form-select">
                            <option value="regular">××©×ª××© ×¨×’×™×œ</option>
                            <option value="admin">××©×ª××© ×× ×”×œ</option>
                        </select>
                        <small style="color: var(--gray-600); font-size: 0.875rem;">××©×ª××© ×¨×’×™×œ ×œ× ×“×•×¨×© ×¡×™×¡××”</small>
                    </div>

                    <div class="form-group">
                        <label class="form-label">× ×ª×•× ×™ ××©×ª××©×™× *</label>
                        <textarea id="bulk-csv-data" class="form-textarea" rows="10"
                            placeholder="×”×–×Ÿ × ×ª×•× ×™× ×‘×¤×•×¨××˜ CSV ××• ××•×¤×¨×“ ×‘×¤×¡×™×§×™×:&#10;123456789,×™×©×¨××œ ×™×©×¨××œ×™,password123&#10;987654321,×©×¨×” ×›×”×Ÿ&#10;&#10;×¤×•×¨××˜: ×ª×¢×•×“×ª_×–×”×•×ª,×©×_××œ×,×¡×™×¡××”(××•×¤×¦×™×•× ×œ×™)&#10;&#10;×”×¢×¨×”: ××©×ª××© ×¨×’×™×œ ×œ× ×“×•×¨×© ×¡×™×¡××”"></textarea>
                    </div>

                    <div class="form-group">
                        <label class="form-label">×©×™×™×š ×œ×˜×•×¤×¡</label>
                        <select id="bulk-form" class="form-select">
                            <option value="">×œ×œ× ×˜×•×¤×¡</option>
                            ${formsOptions}
                        </select>
                    </div>

                    <div class="alert alert-info">
                        <strong>ğŸ’¡ ×”×•×¨××•×ª:</strong><br>
                        â€¢ ×›×œ ×©×•×¨×” ××™×™×¦×’×ª ××©×ª××© ××—×“<br>
                        â€¢ ×¢×‘×•×¨ ××©×ª××© ×¨×’×™×œ: ×ª×¢×•×“×ª_×–×”×•×ª,×©×_××œ×<br>
                        â€¢ ×¢×‘×•×¨ ××©×ª××© ×× ×”×œ: ×ª×¢×•×“×ª_×–×”×•×ª,×©×_××œ×,×¡×™×¡××”<br>
                        â€¢ ×ª×¢×•×“×ª ×–×”×•×ª ×”×™× ×©×“×” ×—×•×‘×”<br>
                        â€¢ × ×™×ª×Ÿ ×œ×”×¤×¨×™×“ ×‘×¤×¡×™×§ ××• ×‘×¢×–×¨×ª CSV
                    </div>
                </form>
            `, [
                {
                    text: '×‘×˜×œ',
                    class: 'btn-secondary',
                    onclick: 'closeModal()'
                },
                {
                    text: '×™×™×‘× ××©×ª××©×™×',
                    class: 'btn-primary',
                    onclick: 'bulkImportUsers()'
                }
            ]);
        }

        // Bulk import users
        async function bulkImportUsers() {
            const csvData = document.getElementById('bulk-csv-data').value.trim();
            const userType = document.getElementById('bulk-user-type').value;
            const formId = document.getElementById('bulk-form').value;

            if (!csvData) {
                showError('× × ×œ×”×–×™×Ÿ × ×ª×•× ×™ ××©×ª××©×™×');
                return;
            }

            try {
                const result = await apiRequest('bulk_import_users', {
                    csv_data: csvData,
                    user_type: userType,
                    form_id: formId || null
                }, 'POST');

                if (result.success) {
                    let message = result.message;
                    if (result.errors && result.errors.length > 0) {
                        message += '\n\n×©×’×™××•×ª:\n' + result.errors.join('\n');
                    }
                    showSuccess(message);
                    closeModal();
                    loadUsers(1);
                } else {
                    showError(result.message || '×©×’×™××” ×‘×™×™×‘×•× ××©×ª××©×™×');
                }
            } catch (error) {
                console.error('Error importing users:', error);
                showError('×©×’×™××” ×‘×™×™×‘×•× ××©×ª××©×™×');
            }
        }

        // Show edit user modal
        async function showEditUserModal(userId) {
            // Get user data
            const usersData = await apiRequest('list_users');
            const user = usersData.users.find(u => u.id == userId);

            if (!user) {
                showError('××©×ª××© ×œ× × ××¦×');
                return;
            }

            showModal('×¢×¨×•×š ××©×ª××©', `
                <form id="edit-user-form">
                    <input type="hidden" id="edit-user-id" value="${userId}">

                    <div class="form-group">
                        <label class="form-label">×ª×¢×•×“×ª ×–×”×•×ª</label>
                        <input type="text" class="form-input" value="${escapeHtml(user.tz)}" disabled>
                        <small style="color: var(--gray-600);">×œ× × ×™×ª×Ÿ ×œ×©× ×•×ª ×ª.×–.</small>
                    </div>

                    <div class="form-group">
                        <label class="form-label">×©× ××œ×</label>
                        <input type="text" id="edit-fullname" class="form-input" value="${escapeHtml(user.full_name || '')}">
                    </div>

                    <div class="form-group">
                        <label class="form-label">×¡×˜×˜×•×¡</label>
                        <select id="edit-active" class="form-select">
                            <option value="1" ${user.is_active == 1 ? 'selected' : ''}>×¤×¢×™×œ</option>
                            <option value="0" ${user.is_active == 0 ? 'selected' : ''}>×œ× ×¤×¢×™×œ</option>
                        </select>
                    </div>
                </form>
            `, [
                {
                    text: '×‘×˜×œ',
                    class: 'btn-secondary',
                    onclick: 'closeModal()'
                },
                {
                    text: '×©××•×¨ ×©×™× ×•×™×™×',
                    class: 'btn-primary',
                    onclick: 'updateUser()'
                }
            ]);
        }

        // Update user
        async function updateUser() {
            const userId = document.getElementById('edit-user-id').value;
            const fullName = document.getElementById('edit-fullname').value.trim();
            const isActive = document.getElementById('edit-active').value;

            try {
                const result = await apiRequest('update_user', {
                    user_id: userId,
                    full_name: fullName,
                    is_active: isActive
                }, 'POST');

                if (result.success) {
                    showSuccess('××©×ª××© ×¢×•×“×›×Ÿ ×‘×”×¦×œ×—×”!');
                    closeModal();
                    loadUsers(currentPage);
                } else {
                    showError(result.message || '×©×’×™××” ×‘×¢×“×›×•×Ÿ ××©×ª××©');
                }
            } catch (error) {
                console.error('Error updating user:', error);
                showError('×©×’×™××” ×‘×¢×“×›×•×Ÿ ××©×ª××©');
            }
        }

        // Delete user
        async function deleteUser(userId, tz) {
            if (!confirmAction(`×”×× ××ª×” ×‘×˜×•×— ×©×‘×¨×¦×•× ×š ×œ××—×•×§ ××ª ×”××©×ª××© ${tz}?\n\n×”×¤×¢×•×œ×” ×ª×©×‘×™×ª ××ª ×”××©×ª××© (×œ× ××—×™×§×” ××•×—×œ×˜×ª).`)) {
                return;
            }

            try {
                const result = await apiRequest('delete_user', {
                    user_id: userId
                }, 'POST');

                if (result.success) {
                    showSuccess('××©×ª××© × ××—×§ ×‘×”×¦×œ×—×”!');
                    loadUsers(currentPage);
                } else {
                    showError(result.message || '×©×’×™××” ×‘××—×™×§×ª ××©×ª××©');
                }
            } catch (error) {
                console.error('Error deleting user:', error);
                showError('×©×’×™××” ×‘××—×™×§×ª ××©×ª××©');
            }
        }
    </script>
</body>
</html>
