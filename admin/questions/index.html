<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>×¡×¤×¨×™×™×ª ×©××œ×•×ª - ××¢×¨×›×ª × ×™×”×•×œ</title>
    <link rel="stylesheet" href="../../style.css">
    <link rel="stylesheet" href="../admin.css">
</head>
<body class="admin-body">
    <!-- Sidebar -->
    <aside class="sidebar">
        <div class="sidebar-header">
            <div class="sidebar-logo">ğŸ‘¨â€ğŸ’¼</div>
            <h2>×¤×× ×œ × ×™×”×•×œ</h2>
            <p class="admin-name" id="admin-name">×˜×•×¢×Ÿ...</p>
        </div>

        <nav class="sidebar-nav">
            <a href="../dashboard.html" class="nav-item">
                <span class="nav-icon">ğŸ“Š</span>
                <span>×œ×•×— ×‘×§×¨×”</span>
            </a>
            <a href="../users/" class="nav-item">
                <span class="nav-icon">ğŸ‘¥</span>
                <span>× ×™×”×•×œ ××©×ª××©×™×</span>
            </a>
            <a href="../forms/" class="nav-item">
                <span class="nav-icon">ğŸ“</span>
                <span>×‘× ×™×™×ª ×˜×¤×¡×™×</span>
            </a>
            <a href="../questions/" class="nav-item active">
                <span class="nav-icon">â“</span>
                <span>×¡×¤×¨×™×™×ª ×©××œ×•×ª</span>
            </a>
            <a href="../responses/" class="nav-item">
                <span class="nav-icon">ğŸ“‹</span>
                <span>×¦×¤×™×™×” ×‘×ª×©×•×‘×•×ª</span>
            </a>
            <a href="#" class="nav-item nav-item-danger" onclick="logout()">
                <span class="nav-icon">ğŸšª</span>
                <span>×”×ª× ×ª×§</span>
            </a>
        </nav>

        <div class="sidebar-footer">
            <p>×’×¨×¡×” 1.0</p>
        </div>
    </aside>

    <!-- Main Content -->
    <main class="admin-main">
        <header class="admin-header">
            <h1>×¡×¤×¨×™×™×ª ×©××œ×•×ª</h1>
            <p>× ×”×œ ××ª ×›×œ ×”×©××œ×•×ª ×‘××¢×¨×›×ª</p>
        </header>

        <!-- Message container -->
        <div id="message-container"></div>

        <!-- Toolbar -->
        <section class="section">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem; gap: 1rem; flex-wrap: wrap;">
                <button class="btn btn-primary" onclick="showCreateQuestionModal()">
                    <span>â•</span>
                    <span>×”×•×¡×£ ×©××œ×”</span>
                </button>

                <div style="display: flex; gap: 1rem; align-items: center; flex: 1; max-width: 600px;">
                    <input
                        type="text"
                        id="search-input"
                        class="form-input"
                        placeholder="×—×¤×© ×©××œ×”..."
                        style="flex: 1;"
                        onkeyup="handleSearch(event)"
                    >
                    <select id="type-filter" class="form-select" style="width: 200px;" onchange="loadQuestions()">
                        <option value="">×›×œ ×”×¡×•×’×™×</option>
                    </select>
                    <button class="btn btn-secondary" onclick="loadQuestions()">
                        <span>ğŸ”„</span>
                    </button>
                </div>
            </div>

            <!-- Questions Grid -->
            <div id="questions-container">
                <div class="loading">
                    <div class="spinner"></div>
                    <p>×˜×•×¢×Ÿ ×©××œ×•×ª...</p>
                </div>
            </div>
        </section>
    </main>

    <script src="../admin.js"></script>
    <script>
        let questionTypes = [];
        let currentSearch = '';
        let currentTypeFilter = '';

        // Load on page load
        window.addEventListener('DOMContentLoaded', async () => {
            await loadQuestionTypes();
            loadQuestions();
        });

        // Load question types
        async function loadQuestionTypes() {
            try {
                const data = await apiRequest('get_question_types');

                if (data && data.success) {
                    questionTypes = data.types;

                    // Populate filter dropdown
                    const filterSelect = document.getElementById('type-filter');
                    filterSelect.innerHTML = '<option value="">×›×œ ×”×¡×•×’×™×</option>' +
                        questionTypes.map(type =>
                            `<option value="${type.id}">${escapeHtml(type.type_name)}</option>`
                        ).join('');
                }
            } catch (error) {
                console.error('Error loading question types:', error);
            }
        }

        // Load questions
        async function loadQuestions() {
            const container = document.getElementById('questions-container');
            container.innerHTML = '<div class="loading"><div class="spinner"></div><p>×˜×•×¢×Ÿ ×©××œ×•×ª...</p></div>';

            currentSearch = document.getElementById('search-input').value.trim();
            currentTypeFilter = document.getElementById('type-filter').value;

            try {
                const data = await apiRequest('list_questions', {
                    search: currentSearch,
                    type_id: currentTypeFilter
                });

                if (!data || !data.success) {
                    container.innerHTML = '<p class="text-center">×©×’×™××” ×‘×˜×¢×™× ×ª ×©××œ×•×ª</p>';
                    return;
                }

                renderQuestions(data.questions);

            } catch (error) {
                console.error('Error loading questions:', error);
                container.innerHTML = '<p class="text-center">×©×’×™××” ×‘×˜×¢×™× ×ª ×©××œ×•×ª</p>';
            }
        }

        // Render questions
        function renderQuestions(questions) {
            const container = document.getElementById('questions-container');

            if (!questions || questions.length === 0) {
                container.innerHTML = `
                    <div style="text-align: center; padding: 3rem;">
                        <div style="font-size: 4rem; margin-bottom: 1rem;">â“</div>
                        <h3>××™×Ÿ ×©××œ×•×ª</h3>
                        <p style="color: var(--gray-600); margin-bottom: 1rem;">
                            ${currentSearch || currentTypeFilter ? '×œ× × ××¦××• ×©××œ×•×ª ×”×ª×•×××•×ª ××ª ×”×—×™×¤×•×©' : '×”×•×¡×£ ×©××œ×” ×—×“×©×” ×›×“×™ ×œ×”×ª×—×™×œ'}
                        </p>
                        ${!currentSearch && !currentTypeFilter ? '<button class="btn btn-primary" onclick="showCreateQuestionModal()">×”×•×¡×£ ×©××œ×”</button>' : ''}
                    </div>
                `;
                return;
            }

            // Group questions by type
            const grouped = {};
            questions.forEach(q => {
                const typeName = q.type_name || '××—×¨';
                if (!grouped[typeName]) {
                    grouped[typeName] = [];
                }
                grouped[typeName].push(q);
            });

            let html = '';

            Object.keys(grouped).sort().forEach(typeName => {
                html += `
                    <div style="margin-bottom: 2rem;">
                        <h3 style="margin-bottom: 1rem; color: var(--primary-color); display: flex; align-items: center; gap: 0.5rem;">
                            <span>${typeName}</span>
                            <span class="badge badge-info">${grouped[typeName].length}</span>
                        </h3>
                        <div style="display: grid; gap: 1rem;">
                            ${grouped[typeName].map(q => renderQuestionCard(q)).join('')}
                        </div>
                    </div>
                `;
            });

            container.innerHTML = html;
        }

        // Render single question card
        function renderQuestionCard(question) {
            const optionsHtml = question.options && question.options !== 'null'
                ? (() => {
                    try {
                        const opts = JSON.parse(question.options);
                        return opts.length > 0
                            ? `<div style="margin-top: 0.5rem; font-size: 0.875rem; color: var(--gray-600);">
                                ××¤×©×¨×•×™×•×ª: ${opts.join(', ')}
                               </div>`
                            : '';
                    } catch (e) {
                        return '';
                    }
                })()
                : '';

            return `
                <div class="card" style="padding: 1rem;">
                    <div style="display: flex; justify-content: space-between; align-items: start;">
                        <div style="flex: 1;">
                            <div style="font-weight: 600; margin-bottom: 0.5rem;">
                                ${escapeHtml(question.question_text)}
                            </div>
                            <div style="display: flex; gap: 0.5rem; flex-wrap: wrap; align-items: center;">
                                <span class="badge badge-info">${escapeHtml(question.type_name)}</span>
                                ${question.is_required ? '<span class="badge badge-warning">× ×“×¨×©</span>' : ''}
                                ${question.used_in_forms > 0
                                    ? `<span class="badge badge-success">×‘×©×™××•×© ×‘-${question.used_in_forms} ×˜×¤×¡×™×</span>`
                                    : '<span class="badge" style="background: var(--gray-200); color: var(--gray-600);">×œ× ×‘×©×™××•×©</span>'}
                            </div>
                            ${optionsHtml}
                        </div>
                        <button class="btn btn-secondary" onclick="viewQuestion(${question.id})" style="padding: 0.5rem 1rem; margin-right: 1rem;">
                            ğŸ‘ï¸
                        </button>
                    </div>
                </div>
            `;
        }

        // Handle search
        function handleSearch(event) {
            if (event.key === 'Enter') {
                loadQuestions();
            }
        }

        // View question details
        async function viewQuestion(questionId) {
            const data = await apiRequest('list_questions');
            const question = data.questions.find(q => q.id == questionId);

            if (!question) {
                showError('×©××œ×” ×œ× × ××¦××”');
                return;
            }

            let optionsHtml = '';
            if (question.options && question.options !== 'null') {
                try {
                    const opts = JSON.parse(question.options);
                    if (opts.length > 0) {
                        optionsHtml = `
                            <div class="form-group">
                                <label class="form-label">××¤×©×¨×•×™×•×ª</label>
                                <ul style="margin: 0; padding-right: 1.5rem;">
                                    ${opts.map(opt => `<li>${escapeHtml(opt)}</li>`).join('')}
                                </ul>
                            </div>
                        `;
                    }
                } catch (e) {}
            }

            showModal('×¤×¨×˜×™ ×©××œ×”', `
                <div>
                    <div class="form-group">
                        <label class="form-label">×˜×§×¡×˜ ×”×©××œ×”</label>
                        <div style="padding: 1rem; background: var(--gray-50); border-radius: 8px;">
                            ${escapeHtml(question.question_text)}
                        </div>
                    </div>

                    <div class="form-group">
                        <label class="form-label">×¡×•×’</label>
                        <div><span class="badge badge-info">${escapeHtml(question.type_name)}</span></div>
                    </div>

                    ${question.placeholder ? `
                        <div class="form-group">
                            <label class="form-label">Placeholder</label>
                            <div>${escapeHtml(question.placeholder)}</div>
                        </div>
                    ` : ''}

                    ${optionsHtml}

                    <div class="form-group">
                        <label class="form-label">× ×“×¨×©</label>
                        <div>${question.is_required ? 'âœ… ×›×Ÿ' : 'âŒ ×œ×'}</div>
                    </div>

                    <div class="form-group">
                        <label class="form-label">×©×™××•×©</label>
                        <div>
                            ${question.used_in_forms > 0
                                ? `×‘×©×™××•×© ×‘-${question.used_in_forms} ×˜×¤×¡×™×`
                                : '×œ× ×‘×©×™××•×© ×›×¨×’×¢'}
                        </div>
                    </div>

                    <div class="form-group">
                        <label class="form-label">×ª××¨×™×š ×™×¦×™×¨×”</label>
                        <div>${formatDate(question.created_at)}</div>
                    </div>
                </div>
            `, [
                {
                    text: '×¡×’×•×¨',
                    class: 'btn-secondary',
                    onclick: 'closeModal()'
                }
            ]);
        }

        // Show create question modal
        function showCreateQuestionModal() {
            const typesOptions = questionTypes.map(type =>
                `<option value="${type.id}">${escapeHtml(type.type_name)}</option>`
            ).join('');

            showModal('×”×•×¡×£ ×©××œ×” ×—×“×©×”', `
                <form id="create-question-form">
                    <div class="form-group">
                        <label class="form-label">×˜×§×¡×˜ ×”×©××œ×” *</label>
                        <input type="text" id="new-question-text" class="form-input" required placeholder="×œ××©×œ: ××”×• ×©××š ×”××œ×?">
                    </div>

                    <div class="form-group">
                        <label class="form-label">×¡×•×’ ×”×©××œ×” *</label>
                        <select id="new-question-type" class="form-select" required onchange="handleTypeChange()">
                            <option value="">×‘×—×¨ ×¡×•×’...</option>
                            ${typesOptions}
                        </select>
                    </div>

                    <div class="form-group">
                        <label class="form-label">Placeholder</label>
                        <input type="text" id="new-placeholder" class="form-input" placeholder="×˜×§×¡×˜ ×¢×–×¨ ×œ×©×“×”">
                    </div>

                    <div class="form-group" id="options-group" style="display: none;">
                        <label class="form-label">××¤×©×¨×•×™×•×ª (××—×ª ×‘×›×œ ×©×•×¨×”)</label>
                        <textarea id="new-options" class="form-textarea" placeholder="××¤×©×¨×•×ª 1
××¤×©×¨×•×ª 2
××¤×©×¨×•×ª 3"></textarea>
                    </div>

                    <div class="form-group">
                        <label style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer;">
                            <input type="checkbox" id="new-required" checked>
                            <span>×©×“×” × ×“×¨×©</span>
                        </label>
                    </div>

                    <div class="alert alert-info">
                        <strong>ğŸ’¡ ×©×™× ×œ×‘:</strong> ×”×©××œ×” ×ª×ª×•×¡×£ ×œ×¡×¤×¨×™×™×” ×•×ª×”×™×” ×–××™× ×” ×œ×©×™××•×© ×‘×˜×¤×¡×™×.
                    </div>
                </form>
            `, [
                {
                    text: '×‘×˜×œ',
                    class: 'btn-secondary',
                    onclick: 'closeModal()'
                },
                {
                    text: '×”×•×¡×£ ×©××œ×”',
                    class: 'btn-primary',
                    onclick: 'createQuestion()'
                }
            ]);
        }

        // Handle type change
        function handleTypeChange() {
            const typeId = document.getElementById('new-question-type').value;
            const type = questionTypes.find(t => t.id == typeId);
            const optionsGroup = document.getElementById('options-group');

            // Show options field for radio, checkbox, select
            if (type && (type.type_code === 'radio' || type.type_code === 'checkbox' || type.type_code === 'select')) {
                optionsGroup.style.display = 'block';
            } else {
                optionsGroup.style.display = 'none';
            }
        }

        // Create question (placeholder - API endpoint needed)
        function createQuestion() {
            showError('×ª×›×•× ×ª ×”×•×¡×¤×ª ×©××œ×•×ª ×ª×”×™×” ×–××™× ×” ×‘×§×¨×•×‘. ×›×¨×’×¢ × ×™×ª×Ÿ ×œ×¦×¤×•×ª ×•×œ×—×¤×© ×‘×©××œ×•×ª ×”×§×™×™××•×ª.');
            // TODO: Implement create_question API endpoint
        }
    </script>
</body>
</html>
