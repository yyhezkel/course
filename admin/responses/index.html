<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>× ×™×”×•×œ ×ª×©×•×‘×•×ª - ××¢×¨×›×ª × ×™×”×•×œ</title>
    <link rel="stylesheet" href="../../style.css?ver=2.0.1">
    <link rel="stylesheet" href="../admin.css?ver=2.0.1">
    <style>
        .responses-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 2rem;
        }

        .filters-section {
            background: var(--white);
            padding: 1.5rem;
            border-radius: 12px;
            box-shadow: var(--shadow-sm);
            margin-bottom: 2rem;
        }

        .filters-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 1rem;
            margin-bottom: 1rem;
        }

        .filter-group {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }

        .filter-label {
            font-size: 0.875rem;
            font-weight: 600;
            color: var(--gray-700);
        }

        .filter-actions {
            display: flex;
            gap: 1rem;
            margin-top: 1rem;
        }

        .responses-table {
            background: var(--white);
            border-radius: 12px;
            overflow: hidden;
            box-shadow: var(--shadow-sm);
        }

        .responses-table table {
            width: 100%;
            border-collapse: collapse;
        }

        .responses-table thead {
            background: var(--gray-50);
            border-bottom: 2px solid var(--gray-200);
        }

        .responses-table th {
            text-align: right;
            padding: 1rem;
            font-weight: 600;
            color: var(--gray-700);
            font-size: 0.875rem;
        }

        .responses-table td {
            padding: 1rem;
            border-bottom: 1px solid var(--gray-100);
            color: var(--gray-900);
        }

        .responses-table tbody tr:hover {
            background: var(--gray-50);
        }

        .status-badge {
            display: inline-block;
            padding: 0.25rem 0.75rem;
            border-radius: 12px;
            font-size: 0.75rem;
            font-weight: 600;
        }

        .status-complete {
            background: #d1fae5;
            color: #065f46;
        }

        .status-partial {
            background: #fef3c7;
            color: #92400e;
        }

        .status-none {
            background: #e5e7eb;
            color: #374151;
        }

        .action-buttons {
            display: flex;
            gap: 0.5rem;
            flex-wrap: wrap;
        }

        .btn-sm {
            font-size: 0.8rem;
            padding: 0.4rem 0.8rem;
        }

        .empty-state {
            text-align: center;
            padding: 4rem 2rem;
            color: var(--gray-400);
        }

        .empty-state-icon {
            font-size: 4rem;
            margin-bottom: 1rem;
        }

        .stats-cards {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
            margin-bottom: 2rem;
        }

        .stat-card {
            background: var(--white);
            padding: 1.5rem;
            border-radius: 12px;
            box-shadow: var(--shadow-sm);
        }

        .stat-value {
            font-size: 2rem;
            font-weight: 700;
            color: var(--primary-color);
            margin-bottom: 0.25rem;
        }

        .stat-label {
            font-size: 0.875rem;
            color: var(--gray-600);
        }
    </style>
</head>
<body class="admin-body">
    <!-- Mobile Menu Toggle -->
    <button class="mobile-menu-toggle" id="mobileMenuToggle" onclick="toggleMobileMenu()">â˜°</button>

    <!-- Sidebar Overlay -->
    <div class="sidebar-overlay" id="sidebarOverlay" onclick="toggleMobileMenu()"></div>

    <!-- Sidebar -->
    <aside class="sidebar" id="sidebar">
        <div class="sidebar-header">
            <div class="sidebar-logo">ğŸ‘¨â€ğŸ’¼</div>
            <h2>×œ×•×— × ×™×”×•×œ</h2>
            <p class="admin-name" id="admin-name">×˜×•×¢×Ÿ...</p>
        </div>

        <nav class="sidebar-nav">
            <a href="../dashboard.html" class="nav-item">
                <span class="nav-icon">ğŸ“Š</span>
                <span>×œ×•×— ×‘×§×¨×”</span>
            </a>

            <div style="padding: 10px 15px; font-size: 12px; color: #9ca3af; text-transform: uppercase; font-weight: 600; margin-top: 10px;">× ×™×”×•×œ ×§×•×¨×¡</div>

            <a href="../course/index.html" class="nav-item">
                <span class="nav-icon">ğŸ“</span>
                <span>×ª×œ××™×“×™×</span>
            </a>
            <a href="../course/tasks.html" class="nav-item">
                <span class="nav-icon">ğŸ“</span>
                <span>×¡×¤×¨×™×™×ª ××©×™××•×ª</span>
            </a>
            <a href="../course/assign.html" class="nav-item">
                <span class="nav-icon">ğŸ“¤</span>
                <span>×”×§×¦××ª ××©×™××•×ª</span>
            </a>
            <a href="../course/materials.html" class="nav-item">
                <span class="nav-icon">ğŸ“š</span>
                <span>×—×•××¨×™ ×œ×™××•×“</span>
            </a>
            <a href="../course/reports.html" class="nav-item">
                <span class="nav-icon">ğŸ“Š</span>
                <span>×“×•×—×•×ª ×•× ×™×ª×•×—</span>
            </a>

            <div style="padding: 10px 15px; font-size: 12px; color: #9ca3af; text-transform: uppercase; font-weight: 600; margin-top: 20px;">× ×™×”×•×œ ×˜×¤×¡×™×</div>

            <a href="../forms/" class="nav-item">
                <span class="nav-icon">ğŸ“‹</span>
                <span>×‘× ×™×™×ª ×˜×¤×¡×™×</span>
            </a>
            <a href="../questions/" class="nav-item">
                <span class="nav-icon">â“</span>
                <span>×¡×¤×¨×™×™×ª ×©××œ×•×ª</span>
            </a>
            <a href="./" class="nav-item active">
                <span class="nav-icon">ğŸ“„</span>
                <span>×ª×©×•×‘×•×ª</span>
            </a>
        </nav>

        <div class="sidebar-footer">
            <button class="logout-btn" onclick="logout()">
                <span>ğŸšª</span>
                <span>×”×ª× ×ª×§</span>
            </button>
        </div>
    </aside>

    <!-- Main Content -->
    <main class="main-content">
        <div class="responses-header">
            <div>
                <h1 class="page-title">ğŸ“‹ ×ª×©×•×‘×•×ª ××©×ª××©×™×</h1>
                <p class="page-subtitle">×¦×¤×™×™×” ×•× ×™×”×•×œ ×ª×©×•×‘×•×ª ×œ××™×œ×•×™ ×˜×¤×¡×™×</p>
            </div>
            <div style="display: flex; gap: 1rem;">
                <button class="btn btn-secondary" onclick="exportToCSV()">
                    ğŸ“¥ ×™×™×¦× ×œ××§×¡×œ
                </button>
                <button class="btn btn-primary" onclick="window.location.reload()">
                    ğŸ”„ ×¨×¢× ×Ÿ
                </button>
            </div>
        </div>

        <!-- Stats Cards -->
        <div class="stats-cards" id="stats-cards">
            <div class="stat-card">
                <div class="stat-value" id="stat-total">-</div>
                <div class="stat-label">×¡×š ×”×›×œ ×ª×©×•×‘×•×ª</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="stat-users">-</div>
                <div class="stat-label">××©×ª××©×™× ×©×¢× ×•</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="stat-forms">-</div>
                <div class="stat-label">×˜×¤×¡×™× ×¤×¢×™×œ×™×</div>
            </div>
        </div>

        <!-- Filters -->
        <div class="filters-section">
            <div class="filters-grid">
                <div class="filter-group">
                    <label class="filter-label">×¡×™× ×•×Ÿ ×œ×¤×™ ×˜×•×¤×¡</label>
                    <select id="filter-form" class="input">
                        <option value="">×›×œ ×”×˜×¤×¡×™×</option>
                    </select>
                </div>
                <div class="filter-group">
                    <label class="filter-label">×—×™×¤×•×© ××©×ª××©</label>
                    <input type="text" id="filter-user" class="input" placeholder="×—×¤×© ×œ×¤×™ ×ª×¢×•×“×ª ×–×”×•×ª ××• ×©×">
                </div>
                <div class="filter-group">
                    <label class="filter-label">××¦×‘ ×”×©×œ××”</label>
                    <select id="filter-status" class="input">
                        <option value="">×”×›×œ</option>
                        <option value="complete">×”×•×©×œ×</option>
                        <option value="partial">×—×œ×§×™</option>
                        <option value="none">×œ× ×”×ª×—×™×œ</option>
                    </select>
                </div>
            </div>
            <div class="filter-actions">
                <button class="btn btn-primary" onclick="applyFilters()">
                    ğŸ” ×—×¤×©
                </button>
                <button class="btn btn-secondary" onclick="clearFilters()">
                    âœ–ï¸ × ×§×”
                </button>
            </div>
        </div>

        <!-- Responses Table -->
        <div class="responses-table">
            <table>
                <thead>
                    <tr>
                        <th>×ª×¢×•×“×ª ×–×”×•×ª</th>
                        <th>×©× ××œ×</th>
                        <th>×˜×•×¤×¡</th>
                        <th>×ª×©×•×‘×•×ª ×©×”×•×©×œ××•</th>
                        <th>××¦×‘</th>
                        <th>×ª××¨×™×š ××—×¨×•×Ÿ</th>
                        <th>×¤×¢×•×œ×•×ª</th>
                    </tr>
                </thead>
                <tbody id="responses-tbody">
                    <tr>
                        <td colspan="7" style="text-align: center; padding: 2rem;">
                            <div class="spinner"></div>
                            <p style="margin-top: 1rem; color: var(--gray-500);">×˜×•×¢×Ÿ × ×ª×•× ×™×...</p>
                        </td>
                    </tr>
                </tbody>
            </table>
        </div>
    </main>

        // Mobile Menu Toggle
        function toggleMobileMenu() {
            const sidebar = document.getElementById('sidebar');
            const overlay = document.getElementById('sidebarOverlay');

            sidebar.classList.toggle('active');
            overlay.classList.toggle('active');

            if (sidebar.classList.contains('active')) {
                overlay.style.display = 'block';
                setTimeout(() => overlay.classList.add('active'), 10);
            } else {
                overlay.classList.remove('active');
                setTimeout(() => overlay.style.display = 'none', 300);
            }
        }

    <script src="../admin.js?ver=2.0.1"></script>
    <script>
        let allResponses = [];
        let allForms = [];

        // Load data on page load
        window.addEventListener('DOMContentLoaded', async () => {
            await loadForms();
            await loadResponses();
        });

        // Load forms for filter dropdown
        async function loadForms() {
            try {
                const response = await fetch('../api.php?action=list_forms', {
                    credentials: 'include'
                });
                const data = await response.json();

                if (data.success) {
                    allForms = data.forms;
                    const select = document.getElementById('filter-form');
                    data.forms.forEach(form => {
                        const option = document.createElement('option');
                        option.value = form.id;
                        option.textContent = form.title;
                        select.appendChild(option);
                    });
                }
            } catch (error) {
                console.error('Error loading forms:', error);
            }
        }

        // Load responses
        async function loadResponses() {
            try {
                const response = await fetch('../api.php?action=list_responses', {
                    credentials: 'include'
                });
                const data = await response.json();

                if (data.success) {
                    allResponses = data.responses;
                    updateStats(data.responses);
                    renderResponses(data.responses);
                } else {
                    showError(data.message);
                }
            } catch (error) {
                console.error('Error loading responses:', error);
                showError('×©×’×™××” ×‘×˜×¢×™× ×ª ×ª×©×•×‘×•×ª');
            }
        }

        // Update stats
        function updateStats(responses) {
            const totalResponses = responses.reduce((sum, r) => sum + parseInt(r.answered_questions || 0), 0);
            const uniqueUsers = new Set(responses.map(r => r.user_id)).size;
            const uniqueForms = new Set(responses.map(r => r.form_title)).size;

            document.getElementById('stat-total').textContent = totalResponses;
            document.getElementById('stat-users').textContent = uniqueUsers;
            document.getElementById('stat-forms').textContent = uniqueForms;
        }

        // Render responses table
        function renderResponses(responses) {
            const tbody = document.getElementById('responses-tbody');

            if (responses.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="7">
                            <div class="empty-state">
                                <div class="empty-state-icon">ğŸ“­</div>
                                <h3>××™×Ÿ ×ª×©×•×‘×•×ª</h3>
                                <p>×œ× × ××¦××• ×ª×©×•×‘×•×ª ××”××©×ª××©×™×</p>
                            </div>
                        </td>
                    </tr>
                `;
                return;
            }

            tbody.innerHTML = responses.map(response => {
                const answeredCount = parseInt(response.answered_questions) || 0;
                let status = 'none';
                let statusText = '×œ× ×”×ª×—×™×œ';

                if (answeredCount > 0 && answeredCount < 10) {
                    status = 'partial';
                    statusText = '×—×œ×§×™';
                } else if (answeredCount >= 10) {
                    status = 'complete';
                    statusText = '×”×•×©×œ×';
                }

                const lastDate = response.last_submission
                    ? new Date(response.last_submission).toLocaleString('he-IL')
                    : '×œ× ×–××™×Ÿ';

                return `
                    <tr>
                        <td>${escapeHtml(response.tz || 'N/A')}</td>
                        <td>${escapeHtml(response.full_name || '×œ× ×¦×•×™×Ÿ')}</td>
                        <td>${escapeHtml(response.form_title || 'N/A')}</td>
                        <td>${answeredCount}</td>
                        <td>
                            <span class="status-badge status-${status}">${statusText}</span>
                        </td>
                        <td>${lastDate}</td>
                        <td>
                            <div class="action-buttons">
                                <button class="btn btn-sm btn-primary" onclick="viewUserResponse(${response.user_id})" title="×¦×¤×” ×‘×ª×©×•×‘×•×ª">
                                    ğŸ‘ï¸
                                </button>
                                <button class="btn btn-sm btn-secondary" onclick="exportUserResponse(${response.user_id})" title="×™×™×¦× CSV">
                                    ğŸ“¥ CSV
                                </button>
                                <button class="btn btn-sm btn-success" onclick="exportUserPDF(${response.user_id})" title="×™×™×¦× PDF">
                                    ğŸ“„ PDF
                                </button>
                            </div>
                        </td>
                    </tr>
                `;
            }).join('');
        }

        // Apply filters
        function applyFilters() {
            const formFilter = document.getElementById('filter-form').value;
            const userFilter = document.getElementById('filter-user').value.toLowerCase();
            const statusFilter = document.getElementById('filter-status').value;

            let filtered = allResponses;

            if (formFilter) {
                const formTitle = allForms.find(f => f.id == formFilter)?.title;
                filtered = filtered.filter(r => r.form_title === formTitle);
            }

            if (userFilter) {
                filtered = filtered.filter(r =>
                    (r.tz && r.tz.toLowerCase().includes(userFilter)) ||
                    (r.full_name && r.full_name.toLowerCase().includes(userFilter))
                );
            }

            if (statusFilter) {
                filtered = filtered.filter(r => {
                    const count = parseInt(r.answered_questions) || 0;
                    if (statusFilter === 'complete') return count >= 10;
                    if (statusFilter === 'partial') return count > 0 && count < 10;
                    if (statusFilter === 'none') return count === 0;
                    return true;
                });
            }

            renderResponses(filtered);
        }

        // Clear filters
        function clearFilters() {
            document.getElementById('filter-form').value = '';
            document.getElementById('filter-user').value = '';
            document.getElementById('filter-status').value = '';
            renderResponses(allResponses);
        }

        // View user response
        async function viewUserResponse(userId) {
            try {
                const response = await fetch(`../api.php?action=get_user_responses&user_id=${userId}`, {
                    credentials: 'include'
                });
                const data = await response.json();

                if (data.success) {
                    showUserResponseModal(data.user, data.responses);
                } else {
                    showError(data.message);
                }
            } catch (error) {
                console.error('Error loading user responses:', error);
                showError('×©×’×™××” ×‘×˜×¢×™× ×ª ×ª×©×•×‘×•×ª ××©×ª××©');
            }
        }

        // Show user response modal
        function showUserResponseModal(user, responses) {
            const modal = document.createElement('div');
            modal.className = 'modal-overlay';
            modal.style.cssText = 'position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); display: flex; align-items: center; justify-content: center; z-index: 1000;';

            const content = document.createElement('div');
            content.style.cssText = 'background: white; border-radius: 12px; padding: 2rem; max-width: 800px; max-height: 80vh; overflow-y: auto; width: 90%;';

            content.innerHTML = `
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 2rem;">
                    <h2 style="margin: 0;">×ª×©×•×‘×•×ª: ${escapeHtml(user.full_name || user.tz)}</h2>
                    <button onclick="this.closest('.modal-overlay').remove()" class="btn btn-secondary">âœ–ï¸</button>
                </div>
                <div style="margin-bottom: 1.5rem; padding: 1rem; background: var(--gray-50); border-radius: 8px;">
                    <p><strong>×ª×¢×•×“×ª ×–×”×•×ª:</strong> ${escapeHtml(user.tz)}</p>
                    <p><strong>×©× ××œ×:</strong> ${escapeHtml(user.full_name || '×œ× ×¦×•×™×Ÿ')}</p>
                    <p><strong>×¡×š ×”×›×œ ×ª×©×•×‘×•×ª:</strong> ${responses.length}</p>
                </div>
                <div style="display: flex; flex-direction: column; gap: 1rem;">
                    ${responses.length > 0 ? responses.map(r => `
                        <div style="padding: 1rem; border: 1px solid var(--gray-200); border-radius: 8px;">
                            <div style="font-weight: 600; color: var(--gray-900); margin-bottom: 0.5rem;">
                                ${escapeHtml(r.question_text)}
                            </div>
                            <div style="color: var(--gray-700); padding: 0.5rem; background: var(--gray-50); border-radius: 4px;">
                                ${escapeHtml(r.answer_value || r.answer_json || '××™×Ÿ ×ª×©×•×‘×”')}
                            </div>
                            <div style="font-size: 0.75rem; color: var(--gray-500); margin-top: 0.5rem;">
                                ×¡×•×’ ×©××œ×”: ${escapeHtml(r.type_name)} | ×ª××¨×™×š: ${new Date(r.submitted_at).toLocaleString('he-IL')}
                            </div>
                        </div>
                    `).join('') : '<p style="text-align: center; color: var(--gray-500);">××™×Ÿ ×ª×©×•×‘×•×ª</p>'}
                </div>
            `;

            modal.appendChild(content);
            document.body.appendChild(modal);

            // Close on backdrop click
            modal.addEventListener('click', (e) => {
                if (e.target === modal) modal.remove();
            });
        }

        // Export user response
        async function exportUserResponse(userId) {
            try {
                const response = await fetch(`../api.php?action=get_user_responses&user_id=${userId}`, {
                    credentials: 'include'
                });
                const data = await response.json();

                if (data.success) {
                    const csv = generateUserCSV(data.user, data.responses);
                    downloadCSV(csv, `×ª×©×•×‘×•×ª_${data.user.tz}.csv`);
                    showSuccess('âœ… ×”×§×•×‘×¥ ×™×•×¦× ×‘×”×¦×œ×—×”');
                } else {
                    showError(data.message);
                }
            } catch (error) {
                console.error('Error exporting user response:', error);
                showError('×©×’×™××” ×‘×™×™×¦×•× ×ª×©×•×‘×•×ª');
            }
        }

        // Export user response as PDF
        function exportUserPDF(userId) {
            // Open PDF export in new window
            window.open(`../export_pdf.php?user_id=${userId}`, '_blank');
            showSuccess('ğŸ“„ ×¤×•×ª×— ×—×œ×•×Ÿ ×™×™×¦×•× PDF...');
        }

        // Generate CSV for single user
        function generateUserCSV(user, responses) {
            let csv = '\uFEFF'; // BOM for Excel Hebrew support
            csv += '×ª×¢×•×“×ª ×–×”×•×ª,×©× ××œ×,×©××œ×”,×ª×©×•×‘×”,×¡×•×’ ×©××œ×”,×ª××¨×™×š\n';

            responses.forEach(r => {
                csv += `"${user.tz}","${user.full_name || ''}","${r.question_text}","${r.answer_value || r.answer_json || ''}","${r.type_name}","${new Date(r.submitted_at).toLocaleString('he-IL')}"\n`;
            });

            return csv;
        }

        // Export all to CSV
        function exportToCSV() {
            let csv = '\uFEFF'; // BOM for Excel Hebrew support
            csv += '×ª×¢×•×“×ª ×–×”×•×ª,×©× ××œ×,×˜×•×¤×¡,×ª×©×•×‘×•×ª ×©×”×•×©×œ××•,×ª××¨×™×š ××—×¨×•×Ÿ\n';

            allResponses.forEach(r => {
                const lastDate = r.last_submission
                    ? new Date(r.last_submission).toLocaleString('he-IL')
                    : '';
                csv += `"${r.tz || ''}","${r.full_name || ''}","${r.form_title || ''}","${r.answered_questions || 0}","${lastDate}"\n`;
            });

            downloadCSV(csv, '×ª×©×•×‘×•×ª_×›×œ_×”××©×ª××©×™×.csv');
            showSuccess('âœ… ×”×§×•×‘×¥ ×™×•×¦× ×‘×”×¦×œ×—×”');
        }

        // Download CSV file
        function downloadCSV(csv, filename) {
            const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            const url = URL.createObjectURL(blob);
            link.setAttribute('href', url);
            link.setAttribute('download', filename);
            link.style.visibility = 'hidden';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }

        // Escape HTML
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        // Show success message
        function showSuccess(message) {
            alert(message);
        }

        // Show error message
        function showError(message) {
            alert(message);
        }

        // Logout
        function logout() {
            if (confirm('×”×× ××ª×” ×‘×˜×•×— ×©×‘×¨×¦×•× ×š ×œ×”×ª× ×ª×§?')) {
                window.location.href = '../index.html?action=logout';
            }
        }
        // Mobile Menu Toggle
        function toggleMobileMenu() {
            const sidebar = document.getElementById('sidebar');
            const overlay = document.getElementById('sidebarOverlay');

            sidebar.classList.toggle('active');
            overlay.classList.toggle('active');

            if (sidebar.classList.contains('active')) {
                overlay.style.display = 'block';
                setTimeout(() => overlay.classList.add('active'), 10);
            } else {
                overlay.classList.remove('active');
                setTimeout(() => overlay.style.display = 'none', 300);
            }
        }

    </script>
</body>
</html>
