<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>×¤×¨×˜×™ ××©×™××”</title>
    <link rel="stylesheet" href="style.css">
    <style>
        .task-container {
            max-width: 900px;
            margin: 0 auto;
            padding: 20px;
        }

        .back-btn {
            display: inline-flex;
            align-items: center;
            gap: 5px;
            background: #f0f0f0;
            color: #333;
            padding: 10px 20px;
            border-radius: 5px;
            text-decoration: none;
            margin-bottom: 20px;
            transition: background 0.3s;
        }

        .back-btn:hover {
            background: #e0e0e0;
        }

        .task-header {
            background: white;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }

        .task-header h1 {
            margin: 0 0 10px 0;
            color: #333;
        }

        .task-status-badge {
            display: inline-block;
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 14px;
            font-weight: bold;
            margin-bottom: 15px;
        }

        .task-status-badge.pending {
            background: #fff3cd;
            color: #856404;
        }

        .task-status-badge.in-progress {
            background: #fff3e0;
            color: #e65100;
        }

        .task-status-badge.completed {
            background: #d4edda;
            color: #155724;
        }

        .task-status-badge.needs-review {
            background: #d1ecf1;
            color: #0c5460;
        }

        .task-meta-info {
            display: flex;
            gap: 20px;
            flex-wrap: wrap;
            padding-top: 15px;
            border-top: 1px solid #e0e0e0;
            margin-top: 15px;
            font-size: 14px;
            color: #666;
        }

        .task-meta-item {
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .task-content {
            background: white;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }

        .task-content h2 {
            margin-top: 0;
            color: #333;
            font-size: 20px;
        }

        .task-description {
            line-height: 1.6;
            color: #555;
            margin-bottom: 20px;
        }

        .task-instructions {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 8px;
            border-right: 4px solid #667eea;
            margin-top: 20px;
        }

        .task-instructions h3 {
            margin-top: 0;
            color: #667eea;
        }

        .materials-section {
            background: white;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }

        .materials-section h2 {
            margin-top: 0;
            color: #333;
            font-size: 20px;
        }

        .material-item {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .material-icon {
            font-size: 24px;
            min-width: 40px;
            text-align: center;
        }

        .material-info {
            flex: 1;
        }

        .material-title {
            font-weight: bold;
            color: #333;
            margin-bottom: 5px;
        }

        .material-description {
            font-size: 13px;
            color: #666;
        }

        .material-link {
            color: #667eea;
            text-decoration: none;
            font-size: 14px;
        }

        .material-link:hover {
            text-decoration: underline;
        }

        .material-content {
            background: white;
            padding: 15px;
            border-radius: 5px;
            margin-top: 10px;
            white-space: pre-wrap;
        }

        .action-section {
            background: white;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }

        .action-btn {
            background: #667eea;
            color: white;
            border: none;
            padding: 15px 30px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 16px;
            font-weight: bold;
            transition: background 0.3s;
            width: 100%;
            margin-bottom: 10px;
        }

        .action-btn:hover {
            background: #5568d3;
        }

        .action-btn:disabled {
            background: #ccc;
            cursor: not-allowed;
        }

        .action-btn.secondary {
            background: #6c757d;
        }

        .action-btn.secondary:hover {
            background: #5a6268;
        }

        .action-btn.success {
            background: #28a745;
        }

        .action-btn.success:hover {
            background: #218838;
        }

        .loading {
            text-align: center;
            padding: 40px;
        }

        .spinner {
            border: 3px solid #f3f3f3;
            border-top: 3px solid #667eea;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .no-materials {
            text-align: center;
            padding: 20px;
            color: #999;
        }

        @media (max-width: 768px) {
            .task-meta-info {
                flex-direction: column;
                gap: 10px;
            }
        }
    </style>
</head>
<body>
    <div class="task-container">
        <!-- Loading State -->
        <div id="loading" class="loading">
            <div class="spinner"></div>
            <p>×˜×•×¢×Ÿ ××©×™××”...</p>
        </div>

        <!-- Task Content (hidden initially) -->
        <div id="taskContent" style="display: none;">
            <a href="dashboard.html" class="back-btn">
                â† ×—×–×¨×” ×œ×œ×•×— ×”××©×™××•×ª
            </a>

            <!-- Task Header -->
            <div class="task-header">
                <span class="task-status-badge" id="taskStatus">×××ª×™× ×”</span>
                <h1 id="taskTitle">××©×™××”</h1>
                <p id="taskDescription" class="task-description"></p>

                <div class="task-meta-info">
                    <div class="task-meta-item" id="durationMeta" style="display: none;">
                        <span>â±ï¸</span>
                        <span id="taskDuration"></span>
                    </div>
                    <div class="task-meta-item" id="pointsMeta" style="display: none;">
                        <span>â­</span>
                        <span id="taskPoints"></span>
                    </div>
                    <div class="task-meta-item" id="dueDateMeta" style="display: none;">
                        <span>ğŸ“…</span>
                        <span id="taskDueDate"></span>
                    </div>
                </div>
            </div>

            <!-- Task Instructions -->
            <div class="task-content" id="instructionsSection" style="display: none;">
                <div class="task-instructions">
                    <h3>×”×•×¨××•×ª</h3>
                    <div id="taskInstructions"></div>
                </div>
            </div>

            <!-- Course Materials -->
            <div class="materials-section" id="materialsSection" style="display: none;">
                <h2>×—×•××¨×™ ×œ×™××•×“</h2>
                <div id="materialsList"></div>
            </div>

            <!-- Action Buttons -->
            <div class="action-section">
                <h2>×¤×¢×•×œ×•×ª</h2>
                <div id="actionButtons"></div>
            </div>
        </div>
    </div>

    <script>
        let taskData = null;
        let userTaskId = null;

        window.addEventListener('DOMContentLoaded', async () => {
            // Get task ID from URL
            const urlParams = new URLSearchParams(window.location.search);
            userTaskId = urlParams.get('id');

            if (!userTaskId) {
                alert('××–×”×” ××©×™××” ×—×¡×¨');
                window.location.href = 'dashboard.html';
                return;
            }

            const authenticated = await checkSession();
            if (!authenticated) {
                window.location.href = 'index.html';
                return;
            }

            await loadTask();
        });

        async function checkSession() {
            try {
                const response = await fetch('api.php', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    credentials: 'include',
                    body: JSON.stringify({ action: 'check_session' })
                });
                const data = await response.json();
                return data.authenticated;
            } catch (error) {
                console.error('Session check error:', error);
                return false;
            }
        }

        async function loadTask() {
            try {
                const response = await fetch('api.php', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    credentials: 'include',
                    body: JSON.stringify({
                        action: 'get_task_detail',
                        user_task_id: userTaskId
                    })
                });

                if (!response.ok) {
                    throw new Error('Failed to load task');
                }

                const data = await response.json();

                if (data.success) {
                    taskData = data.task;
                    renderTask();
                } else {
                    throw new Error(data.message || 'Failed to load task');
                }
            } catch (error) {
                console.error('Error loading task:', error);
                document.getElementById('loading').innerHTML = `
                    <p style="color: red;">×©×’×™××” ×‘×˜×¢×™× ×ª ×”××©×™××”</p>
                    <p>${error.message}</p>
                    <button onclick="window.location.href='dashboard.html'" style="padding: 10px 20px;">×—×–×¨×” ×œ×œ×•×— ×”××©×™××•×ª</button>
                `;
            }
        }

        function renderTask() {
            document.getElementById('loading').style.display = 'none';
            document.getElementById('taskContent').style.display = 'block';

            // Set task header
            document.getElementById('taskTitle').textContent = taskData.title;
            document.getElementById('taskDescription').textContent = taskData.description || '';

            const statusBadge = document.getElementById('taskStatus');
            statusBadge.textContent = getStatusText(taskData.status);
            statusBadge.className = 'task-status-badge ' + taskData.status.replace('_', '-');

            // Set meta info
            if (taskData.estimated_duration) {
                document.getElementById('durationMeta').style.display = 'flex';
                document.getElementById('taskDuration').textContent = `${taskData.estimated_duration} ×“×§×•×ª`;
            }

            if (taskData.points) {
                document.getElementById('pointsMeta').style.display = 'flex';
                document.getElementById('taskPoints').textContent = `${taskData.points} × ×§×•×“×•×ª`;
            }

            if (taskData.due_date) {
                document.getElementById('dueDateMeta').style.display = 'flex';
                const dueDate = new Date(taskData.due_date).toLocaleDateString('he-IL');
                document.getElementById('taskDueDate').textContent = `×ª××¨×™×š ×™×¢×“: ${dueDate}`;
            }

            // Set instructions
            if (taskData.instructions) {
                document.getElementById('instructionsSection').style.display = 'block';
                document.getElementById('taskInstructions').innerHTML = taskData.instructions.replace(/\n/g, '<br>');
            }

            // Render materials
            renderMaterials();

            // Render action buttons
            renderActions();
        }

        function renderMaterials() {
            const materials = taskData.materials || [];

            if (materials.length === 0) {
                return; // Keep section hidden if no materials
            }

            document.getElementById('materialsSection').style.display = 'block';
            const materialsList = document.getElementById('materialsList');

            materialsList.innerHTML = materials.map(material => {
                const icon = getMaterialIcon(material.material_type);

                let content = '';
                if (material.external_url) {
                    content = `<a href="${material.external_url}" target="_blank" class="material-link">×¤×ª×— ×§×™×©×•×¨ â†</a>`;
                } else if (material.file_path) {
                    content = `<a href="${material.file_path}" target="_blank" class="material-link">×”×•×¨×“ ×§×•×‘×¥ â†</a>`;
                } else if (material.content_text) {
                    content = `<div class="material-content">${material.content_text}</div>`;
                }

                return `
                    <div class="material-item">
                        <div class="material-icon">${icon}</div>
                        <div class="material-info">
                            <div class="material-title">${material.title}</div>
                            ${material.description ? `<div class="material-description">${material.description}</div>` : ''}
                            ${content}
                        </div>
                    </div>
                `;
            }).join('');
        }

        function renderActions() {
            const actionButtons = document.getElementById('actionButtons');
            let buttons = '';

            switch (taskData.status) {
                case 'pending':
                    buttons = `
                        <button class="action-btn" onclick="startTask()">×”×ª×—×œ ××©×™××”</button>
                    `;
                    break;

                case 'in_progress':
                    if (taskData.form_id) {
                        buttons = `
                            <button class="action-btn" onclick="goToForm()">×”××©×š ×œ××™×œ×•×™ ×˜×•×¤×¡</button>
                            <button class="action-btn secondary" onclick="markComplete()">×¡×™××•×Ÿ ×›×”×•×©×œ×</button>
                        `;
                    } else {
                        buttons = `
                            <button class="action-btn success" onclick="markComplete()">×¡×™××•×Ÿ ×›×”×•×©×œ×</button>
                        `;
                    }
                    break;

                case 'completed':
                case 'needs_review':
                    buttons = `
                        <button class="action-btn" disabled>×”××©×™××” ×”×•×’×©×” ×•××—×›×” ×œ×‘×“×™×§×”</button>
                    `;
                    break;

                case 'approved':
                    buttons = `
                        <button class="action-btn success" disabled>âœ“ ×”××©×™××” ××•×©×¨×”</button>
                    `;
                    break;

                case 'rejected':
                    buttons = `
                        <button class="action-btn" onclick="startTask()">×ª×§×Ÿ ×•×©×œ×— ××—×“×©</button>
                        ${taskData.review_notes ? `<div style="margin-top: 15px; padding: 15px; background: #fff3cd; border-radius: 5px;"><strong>×”×¢×¨×•×ª ×”×× ×—×”:</strong><br>${taskData.review_notes}</div>` : ''}
                    `;
                    break;
            }

            actionButtons.innerHTML = buttons;
        }

        async function startTask() {
            try {
                const response = await fetch('api.php', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    credentials: 'include',
                    body: JSON.stringify({
                        action: 'update_task_status',
                        user_task_id: userTaskId,
                        status: 'in_progress'
                    })
                });

                const data = await response.json();
                if (data.success) {
                    taskData.status = 'in_progress';
                    renderTask();
                } else {
                    alert('×©×’×™××” ×‘×¢×“×›×•×Ÿ ×¡×˜×˜×•×¡ ×”××©×™××”');
                }
            } catch (error) {
                console.error('Error starting task:', error);
                alert('×©×’×™××” ×‘×¢×“×›×•×Ÿ ×¡×˜×˜×•×¡ ×”××©×™××”');
            }
        }

        async function markComplete() {
            if (!confirm('×”×× ××ª×” ×‘×˜×•×— ×©×‘×¨×¦×•× ×š ×œ×¡××Ÿ ××ª ×”××©×™××” ×›×”×•×©×œ××”?')) {
                return;
            }

            try {
                const response = await fetch('api.php', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    credentials: 'include',
                    body: JSON.stringify({
                        action: 'update_task_status',
                        user_task_id: userTaskId,
                        status: 'needs_review'
                    })
                });

                const data = await response.json();
                if (data.success) {
                    alert('×”××©×™××” ×”×•×’×©×” ×‘×”×¦×œ×—×”!');
                    window.location.href = 'dashboard.html';
                } else {
                    alert('×©×’×™××” ×‘×”×’×©×ª ×”××©×™××”');
                }
            } catch (error) {
                console.error('Error completing task:', error);
                alert('×©×’×™××” ×‘×”×’×©×ª ×”××©×™××”');
            }
        }

        function goToForm() {
            // Redirect to form page with task context
            window.location.href = `index.html?task=${userTaskId}`;
        }

        function getStatusText(status) {
            const statusMap = {
                'pending': '×××ª×™× ×”',
                'in_progress': '×‘×ª×”×œ×™×š',
                'completed': '×”×•×©×œ××”',
                'needs_review': '×××ª×™× ×” ×œ×‘×“×™×§×”',
                'approved': '××•×©×¨×”',
                'rejected': '× ×“×—×ª×”'
            };
            return statusMap[status] || status;
        }

        function getMaterialIcon(type) {
            const iconMap = {
                'text': 'ğŸ“„',
                'pdf': 'ğŸ“•',
                'video': 'ğŸ¥',
                'link': 'ğŸ”—',
                'document': 'ğŸ“‹'
            };
            return iconMap[type] || 'ğŸ“';
        }
    </script>
</body>
</html>
