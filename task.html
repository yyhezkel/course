<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>×¤×¨×˜×™ ××©×™××”</title>
    <link rel="stylesheet" href="user.css">
</head>
<body>
    <div class="task-container">
        <!-- Loading State -->
        <div id="loading" class="loading">
            <div class="spinner"></div>
            <p>×˜×•×¢×Ÿ ××©×™××”...</p>
        </div>

        <!-- Task Content (hidden initially) -->
        <div id="taskContent" style="display: none;">
            <a href="dashboard.html" class="back-btn">
                â† ×—×–×¨×” ×œ×œ×•×— ×”××©×™××•×ª
            </a>

            <!-- Task Header -->
            <div class="task-header">
                <span class="task-status-badge" id="taskStatus">×××ª×™× ×”</span>
                <h1 id="taskTitle">××©×™××”</h1>
                <p id="taskDescription" class="task-description"></p>

                <div class="task-meta-info">
                    <div class="task-meta-item" id="durationMeta" style="display: none;">
                        <span>â±ï¸</span>
                        <span id="taskDuration"></span>
                    </div>
                    <div class="task-meta-item" id="pointsMeta" style="display: none;">
                        <span>â­</span>
                        <span id="taskPoints"></span>
                    </div>
                    <div class="task-meta-item" id="dueDateMeta" style="display: none;">
                        <span>ğŸ“…</span>
                        <span id="taskDueDate"></span>
                    </div>
                </div>
            </div>

            <!-- Task Instructions -->
            <div class="task-content" id="instructionsSection" style="display: none;">
                <div class="task-instructions">
                    <h3>×”×•×¨××•×ª</h3>
                    <div id="taskInstructions"></div>
                </div>
            </div>

            <!-- Course Materials -->
            <div class="materials-section" id="materialsSection" style="display: none;">
                <h2>×—×•××¨×™ ×œ×™××•×“</h2>
                <div id="materialsList"></div>
            </div>

            <!-- Action Buttons -->
            <div class="action-section">
                <h2>×¤×¢×•×œ×•×ª</h2>
                <div id="actionButtons"></div>

                <!-- File Upload Section -->
                <div class="file-upload-section" id="fileUploadSection" style="display: none;">
                    <h3>×”×¢×œ××ª ×§×‘×¦×™×</h3>
                    <div class="file-input-wrapper">
                        <input type="file" id="fileInput" accept=".pdf,.doc,.docx,.xls,.xlsx,.jpg,.jpeg,.png,.gif,.txt,.zip">
                        <input type="text" id="fileDescription" placeholder="×ª×™××•×¨ ×”×§×•×‘×¥ (××•×¤×¦×™×•× ×œ×™)">
                        <button class="action-btn" onclick="uploadFile()" style="margin-top: 10px;">×”×¢×œ×” ×§×•×‘×¥</button>
                    </div>
                    <div class="upload-progress" id="uploadProgress">
                        <div class="progress-bar-small">
                            <div class="progress-bar-fill-small" id="uploadProgressBar" style="width: 0%">0%</div>
                        </div>
                    </div>
                </div>

                <!-- Uploaded Files List -->
                <div class="uploaded-files" id="uploadedFiles" style="display: none;">
                    <h3>×§×‘×¦×™× ×©×”×•×¢×œ×•</h3>
                    <div id="filesList"></div>
                </div>
            </div>
        </div>
    </div>

    <script>
        let taskData = null;
        let userTaskId = null;

        window.addEventListener('DOMContentLoaded', async () => {
            // Get task ID from URL
            const urlParams = new URLSearchParams(window.location.search);
            userTaskId = urlParams.get('id');

            if (!userTaskId) {
                alert('××–×”×” ××©×™××” ×—×¡×¨');
                window.location.href = 'dashboard.html';
                return;
            }

            const authenticated = await checkSession();
            if (!authenticated) {
                window.location.href = 'index.html';
                return;
            }

            await loadTask();
        });

        async function checkSession() {
            try {
                const response = await fetch('api.php', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    credentials: 'include',
                    body: JSON.stringify({ action: 'check_session' })
                });
                const data = await response.json();
                return data.authenticated;
            } catch (error) {
                console.error('Session check error:', error);
                return false;
            }
        }

        async function loadTask() {
            try {
                const response = await fetch('api.php', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    credentials: 'include',
                    body: JSON.stringify({
                        action: 'get_task_detail',
                        user_task_id: userTaskId
                    })
                });

                if (!response.ok) {
                    throw new Error('Failed to load task');
                }

                const data = await response.json();

                if (data.success) {
                    taskData = data.task;
                    renderTask();
                } else {
                    throw new Error(data.message || 'Failed to load task');
                }
            } catch (error) {
                console.error('Error loading task:', error);
                document.getElementById('loading').innerHTML = `
                    <p style="color: red;">×©×’×™××” ×‘×˜×¢×™× ×ª ×”××©×™××”</p>
                    <p>${error.message}</p>
                    <button onclick="window.location.href='dashboard.html'" style="padding: 10px 20px;">×—×–×¨×” ×œ×œ×•×— ×”××©×™××•×ª</button>
                `;
            }
        }

        function renderTask() {
            document.getElementById('loading').style.display = 'none';
            document.getElementById('taskContent').style.display = 'block';

            // Set task header
            document.getElementById('taskTitle').textContent = taskData.title;
            document.getElementById('taskDescription').textContent = taskData.description || '';

            const statusBadge = document.getElementById('taskStatus');
            statusBadge.textContent = getStatusText(taskData.status);
            statusBadge.className = 'task-status-badge ' + taskData.status.replace('_', '-');

            // Set meta info
            if (taskData.estimated_duration) {
                document.getElementById('durationMeta').style.display = 'flex';
                document.getElementById('taskDuration').textContent = `${taskData.estimated_duration} ×“×§×•×ª`;
            }

            if (taskData.points) {
                document.getElementById('pointsMeta').style.display = 'flex';
                document.getElementById('taskPoints').textContent = `${taskData.points} × ×§×•×“×•×ª`;
            }

            if (taskData.due_date) {
                document.getElementById('dueDateMeta').style.display = 'flex';
                const dueDate = new Date(taskData.due_date).toLocaleDateString('he-IL');
                document.getElementById('taskDueDate').textContent = `×ª××¨×™×š ×™×¢×“: ${dueDate}`;
            }

            // Set instructions
            if (taskData.instructions) {
                document.getElementById('instructionsSection').style.display = 'block';
                document.getElementById('taskInstructions').innerHTML = taskData.instructions.replace(/\n/g, '<br>');
            }

            // Render materials
            renderMaterials();

            // Render action buttons
            renderActions();
        }

        function renderMaterials() {
            const materials = taskData.materials || [];

            if (materials.length === 0) {
                return; // Keep section hidden if no materials
            }

            document.getElementById('materialsSection').style.display = 'block';
            const materialsList = document.getElementById('materialsList');

            materialsList.innerHTML = materials.map(material => {
                const icon = getMaterialIcon(material.material_type);

                let content = '';
                if (material.external_url) {
                    content = `<a href="${material.external_url}" target="_blank" class="material-link">×¤×ª×— ×§×™×©×•×¨ â†</a>`;
                } else if (material.file_path) {
                    content = `<a href="${material.file_path}" target="_blank" class="material-link">×”×•×¨×“ ×§×•×‘×¥ â†</a>`;
                } else if (material.content_text) {
                    content = `<div class="material-content">${material.content_text}</div>`;
                }

                return `
                    <div class="material-item">
                        <div class="material-icon">${icon}</div>
                        <div class="material-info">
                            <div class="material-title">${material.title}</div>
                            ${material.description ? `<div class="material-description">${material.description}</div>` : ''}
                            ${content}
                        </div>
                    </div>
                `;
            }).join('');
        }

        function renderActions() {
            const actionButtons = document.getElementById('actionButtons');
            let buttons = '';

            switch (taskData.status) {
                case 'pending':
                    buttons = `
                        <button class="action-btn" onclick="startTask()">×”×ª×—×œ ××©×™××”</button>
                    `;
                    break;

                case 'in_progress':
                    if (taskData.form_id) {
                        buttons = `
                            <button class="action-btn" onclick="goToForm()">×”××©×š ×œ××™×œ×•×™ ×˜×•×¤×¡</button>
                            <button class="action-btn secondary" onclick="markComplete()">×¡×™××•×Ÿ ×›×”×•×©×œ×</button>
                        `;
                    } else {
                        buttons = `
                            <button class="action-btn success" onclick="markComplete()">×¡×™××•×Ÿ ×›×”×•×©×œ×</button>
                        `;
                    }
                    break;

                case 'completed':
                case 'needs_review':
                    buttons = `
                        <button class="action-btn" disabled>×”××©×™××” ×”×•×’×©×” ×•××—×›×” ×œ×‘×“×™×§×”</button>
                    `;
                    break;

                case 'approved':
                    buttons = `
                        <button class="action-btn success" disabled>âœ“ ×”××©×™××” ××•×©×¨×”</button>
                    `;
                    break;

                case 'rejected':
                    buttons = `
                        <button class="action-btn" onclick="startTask()">×ª×§×Ÿ ×•×©×œ×— ××—×“×©</button>
                        ${taskData.review_notes ? `<div style="margin-top: 15px; padding: 15px; background: #fff3cd; border-radius: 5px;"><strong>×”×¢×¨×•×ª ×”×× ×—×”:</strong><br>${taskData.review_notes}</div>` : ''}
                    `;
                    break;
            }

            actionButtons.innerHTML = buttons;

            // Show/hide file upload section based on status
            const fileUploadSection = document.getElementById('fileUploadSection');
            if (taskData.status === 'in_progress' || taskData.status === 'rejected') {
                fileUploadSection.style.display = 'block';
                loadUploadedFiles(); // Load any existing files
            } else {
                fileUploadSection.style.display = 'none';
            }

            // Always try to load uploaded files to show them
            loadUploadedFiles();
        }

        async function startTask() {
            try {
                const response = await fetch('api.php', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    credentials: 'include',
                    body: JSON.stringify({
                        action: 'update_task_status',
                        user_task_id: userTaskId,
                        status: 'in_progress'
                    })
                });

                const data = await response.json();
                if (data.success) {
                    taskData.status = 'in_progress';
                    renderTask();
                } else {
                    alert('×©×’×™××” ×‘×¢×“×›×•×Ÿ ×¡×˜×˜×•×¡ ×”××©×™××”');
                }
            } catch (error) {
                console.error('Error starting task:', error);
                alert('×©×’×™××” ×‘×¢×“×›×•×Ÿ ×¡×˜×˜×•×¡ ×”××©×™××”');
            }
        }

        async function markComplete() {
            if (!confirm('×”×× ××ª×” ×‘×˜×•×— ×©×‘×¨×¦×•× ×š ×œ×¡××Ÿ ××ª ×”××©×™××” ×›×”×•×©×œ××”?')) {
                return;
            }

            try {
                const response = await fetch('api.php', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    credentials: 'include',
                    body: JSON.stringify({
                        action: 'update_task_status',
                        user_task_id: userTaskId,
                        status: 'needs_review'
                    })
                });

                const data = await response.json();
                if (data.success) {
                    alert('×”××©×™××” ×”×•×’×©×” ×‘×”×¦×œ×—×”!');
                    window.location.href = 'dashboard.html';
                } else {
                    alert('×©×’×™××” ×‘×”×’×©×ª ×”××©×™××”');
                }
            } catch (error) {
                console.error('Error completing task:', error);
                alert('×©×’×™××” ×‘×”×’×©×ª ×”××©×™××”');
            }
        }

        function goToForm() {
            // Redirect to form page with task context
            // The form will know to return here when done
            window.location.href = `index.html?task=${userTaskId}&form_id=${taskData.form_id}`;
        }

        function getStatusText(status) {
            const statusMap = {
                'pending': '×××ª×™× ×”',
                'in_progress': '×‘×ª×”×œ×™×š',
                'completed': '×”×•×©×œ××”',
                'needs_review': '×××ª×™× ×” ×œ×‘×“×™×§×”',
                'approved': '××•×©×¨×”',
                'rejected': '× ×“×—×ª×”'
            };
            return statusMap[status] || status;
        }

        function getMaterialIcon(type) {
            const iconMap = {
                'text': 'ğŸ“„',
                'pdf': 'ğŸ“•',
                'video': 'ğŸ¥',
                'link': 'ğŸ”—',
                'document': 'ğŸ“‹'
            };
            return iconMap[type] || 'ğŸ“';
        }

        // File Upload Functions
        async function uploadFile() {
            const fileInput = document.getElementById('fileInput');
            const description = document.getElementById('fileDescription').value;

            if (!fileInput.files || fileInput.files.length === 0) {
                alert('×× × ×‘×—×¨ ×§×•×‘×¥ ×œ×”×¢×œ××”');
                return;
            }

            const file = fileInput.files[0];

            // Validate file size (10MB max)
            if (file.size > 10 * 1024 * 1024) {
                alert('×”×§×•×‘×¥ ×’×“×•×œ ××“×™. ××§×¡×™××•× 10MB');
                return;
            }

            const formData = new FormData();
            formData.append('file', file);
            formData.append('user_task_id', userTaskId);
            formData.append('description', description);

            try {
                // Show progress bar
                const progressDiv = document.getElementById('uploadProgress');
                const progressBar = document.getElementById('uploadProgressBar');
                progressDiv.style.display = 'block';

                const xhr = new XMLHttpRequest();

                // Track upload progress
                xhr.upload.addEventListener('progress', (e) => {
                    if (e.lengthComputable) {
                        const percentComplete = Math.round((e.loaded / e.total) * 100);
                        progressBar.style.width = percentComplete + '%';
                        progressBar.textContent = percentComplete + '%';
                    }
                });

                // Handle completion
                xhr.addEventListener('load', async () => {
                    progressDiv.style.display = 'none';
                    progressBar.style.width = '0%';
                    progressBar.textContent = '0%';

                    if (xhr.status === 200) {
                        const data = JSON.parse(xhr.responseText);
                        if (data.success) {
                            alert('×”×§×•×‘×¥ ×”×•×¢×œ×” ×‘×”×¦×œ×—×”!');
                            fileInput.value = '';
                            document.getElementById('fileDescription').value = '';
                            await loadUploadedFiles();
                            // Reload task to get updated status
                            await loadTask();
                        } else {
                            alert('×©×’×™××”: ' + data.message);
                        }
                    } else {
                        alert('×©×’×™××” ×‘×”×¢×œ××ª ×”×§×•×‘×¥');
                    }
                });

                // Handle errors
                xhr.addEventListener('error', () => {
                    progressDiv.style.display = 'none';
                    alert('×©×’×™××” ×‘×”×¢×œ××ª ×”×§×•×‘×¥');
                });

                xhr.open('POST', 'upload.php');
                xhr.withCredentials = true;
                xhr.send(formData);

            } catch (error) {
                console.error('Upload error:', error);
                alert('×©×’×™××” ×‘×”×¢×œ××ª ×”×§×•×‘×¥');
            }
        }

        async function loadUploadedFiles() {
            try {
                const response = await fetch(`upload.php?user_task_id=${userTaskId}`, {
                    method: 'GET',
                    credentials: 'include'
                });

                const data = await response.json();

                if (data.success && data.submissions.length > 0) {
                    document.getElementById('uploadedFiles').style.display = 'block';
                    renderUploadedFiles(data.submissions);
                } else {
                    document.getElementById('uploadedFiles').style.display = 'none';
                }
            } catch (error) {
                console.error('Error loading files:', error);
            }
        }

        function renderUploadedFiles(submissions) {
            const filesList = document.getElementById('filesList');

            filesList.innerHTML = submissions.map(file => {
                const sizeKB = Math.round(file.filesize / 1024);
                const uploadDate = new Date(file.uploaded_at).toLocaleDateString('he-IL');
                const icon = getFileIcon(file.mime_type);

                return `
                    <div class="file-item">
                        <div class="file-item-info">
                            <span class="file-icon">${icon}</span>
                            <div>
                                <div class="file-name">${file.original_filename}</div>
                                <div class="file-size">${sizeKB} KB â€¢ ${uploadDate}</div>
                                ${file.description ? `<div class="file-size">${file.description}</div>` : ''}
                            </div>
                        </div>
                        <a href="download.php?id=${file.id}&type=submission" class="file-download-btn" download>×”×•×¨×“×”</a>
                    </div>
                `;
            }).join('');
        }

        function getFileIcon(mimeType) {
            if (mimeType.includes('pdf')) return 'ğŸ“•';
            if (mimeType.includes('word') || mimeType.includes('document')) return 'ğŸ“„';
            if (mimeType.includes('excel') || mimeType.includes('spreadsheet')) return 'ğŸ“Š';
            if (mimeType.includes('image')) return 'ğŸ–¼ï¸';
            if (mimeType.includes('zip')) return 'ğŸ—œï¸';
            return 'ğŸ“';
        }
    </script>
</body>
</html>
